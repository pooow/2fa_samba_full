= Настройка двухфакторной аутентификации в домене Samba AD
:doctype: book
:chapter-signifier: #
:toc:
:toc-title: Оглавление
:toclevels: 5
:sectnums:
:sectnumlevels: 5


<<<

== Общая информация

Двухфакторная аутентификация (2ФА,2FA) — это метод идентификации пользователя в каком-либо сервисе при помощи запроса аутентификационных данных двух разных типов. Суть 2ФА: чтобы куда-то попасть, необходимо подтвердить тот факт, что вы — это вы, причём при помощи двух факторов («ключей»), одним из которых вы владеете, а другой знаете (держите в памяти). +
Совместно токен и PIN-код формируют такую систему 2ФА: токен — «ключ», которым вы владеете, а PIN-код к нему — «ключ», который вы знаете, т.е. в данном случае: 1-й фактор — наличие сертификата пользователя на токене, выданного Центром Сертификации (ЦС), а 2-й фактор — наличие доступа к сертификату пользователя на токене — знание PIN-кода.

=== Об этом документе

Настоящий документ можно считать практическим руководством для конечного пользователя с методическими рекомендациями по контролю за успешностью выполнения настройки. +
Из этого документа станет понятно, как настроить 2ФА в домене Samba AD в ОС «Альт 8 СП»: убедиться, что токены, содержащие криптографическую информацию, позволяют зарегистрироваться в ОС «Альт 8 СП» в домене Samba AD при корректном вводе PIN-кода, без дополнительных способов аутентификации (например, ввода пароля), а также убедиться в обратном, что при вводе некорректного PIN-кода в аутентификации 
будет отказано. Также в аутентификации будет отказано если сертификат отозван Центром Сертификации (ЦС). +
Под криптографической информацией на токене здесь явно подразумеваются сертификат пользователя, выданный ЦС, открытый и закрытый ключи пользователя.

=== Общая схема работы доменной 2ФА

Когда происходит вход пользователя в систему:

. предъявляется имя пользователя (в консоли или менеджеру дисплеев)
. PAM-модуль (pam_sss) и служба SSSD проверяет для этого имени пользователя доступность 
аутентификации по токену, а именно:
.. наличие сертификата на токене
.. существует ли соответствие имени пользователя и данных из сертификата
... по-умолчанию проверяется соответствие сертификата на токене и сертификата в базе LDAP Samba AD для этого пользователя
... если сертификата в базе LDAP Samba AD нет, то соответствие ищется согласно правилу `maprule` службы SSSD
. при наличии соответствия сертификата и доменного пользователя запускается процесс PKINIT
.. выдаётся запрос на ввод PIN-кода
.. если PIN-код корректный, то проверяется соответствие всей цепочки сертификатов: пользователя, домена FreeIPA и ЦС
.. если цепочка сертификатов успешно проверена пользователю выдается билет Kerberos и осуществляется вход в ОС
. если проверки не пройдены и существует альтернативный способ аутентификации, предлагается им воспользоваться, иначе вход в ОС отвергается

PKINIT - это механизм предварительной аутентификации (до приглашения ввести пароль) для Kerberos 5, который использует сертификаты X.509 для аутентификации KDC для клиентов и наоборот.

=== Какие ОС используем для настройки

Для настройки используется ОС с менеджером дисплеев LightDM и графическим окружением Mate, на примере ОС «Альт 8 СП» в исполнении «Рабочая станция», в качестве клиента домена Samba AD и ОС «Альт 8 СП СЕРВЕР» в качестве домена Samba AD. Релиз 8.4, репозиторий CF2.

=== Какие токены используем для настройки

Для настройки используем токены с аппаратной поддержкой криптографических функций. В таких токенах приватный ключ генерируется непосредственно на токене и является неизвлекаемым. В этом случае администратор инфраструктуры PKI может быть уверен, что для 2ФА приватный ключ на токене, на основе которого был получен сертификат, не может быть каким-либо образом скопирован или размножен, в отличие от обычных токенов, где контейнер с криптографической информацией может быть скопирован на другой токен и в таком случае одного фактора система 2ФА будет лишена. +
Перечень подходящих токенов можно посмотреть в документе «Методика тестирования токенов». +
Токены, используемые в настоящем руководстве: *Rutoken ECP*, *JaCarta-2 SE*, *ESMART Token*.

=== Какие протоколы шифрования используем

Для настройки доменной 2ФА используется протокол шифрования RSA.Он выбран из-за поддержки всеми компонентами, участвующими в процессе 2ФА, а именно:

* библиотеки вендоров pkcs11;
* openssl engine (engine,который позволяет работать с токеном, а не тот openssl-gost-engine, который может работать с протоколами ГОСТ, но без токена);
* служба аутентификации SSSD
* Kerberos PKINIT
* ЦС сервера Samba AD

Отечественные протоколы шифрования ГОСТ поддерживаются библиотеками вендоров pkcs11, но openssl engine и PAM-модуль, с поддержкой протоколов ГОСТ, предоставляются только компанией Актив для своих токенов (Рутокен). +
Cлужба аутентификации SSSD, MIT Kerberos и Dogtag (ЦС сервера FreeIPA) протоколы шифрования ГОСТ не поддерживают.

=== Предварительные условия

Перед настройкой доменной 2ФА необходимо убедиться, что токены корректно взаимодействуют с ОС по протоколу PC/SC, а также поддерживается функционал библиотек вендоров PKCS11. Сделать это можно в соответствии с отдельным документом «Методика тестирования токенов».

== Настройка и проверка работы

=== Базовая конфигурация стенда

Стенд состоит из контроллера домена Samba AD и клиента домена.

Контроллер домена настроен по инструкции https://altsp.su/export/sites/altsp/.galleries/documentation/fstek/lknv.11100-01-90-01-rukovodstvo-administratora.pdf, п.9.1.1. Samba 4 в роли контроллера домена Active Directory или https://www.altlinux.org/ActiveDirectory/DC

==== Cозданиe домена Samba AD

[source,subs="verbatim,quotes"]
----
sp8-srv-2022 ~ # *apt-get install task-samba-dc*
sp8-srv-2022 ~ # *for service in smb nmb krb5kdc slapd bind; \*
*do chkconfig $service off; service $service stop; done*
sp8-srv-2022 ~ # *rm -f /etc/samba/smb.conf*
sp8-srv-2022 ~ # *rm -rf /var/lib/samba*
sp8-srv-2022 ~ # *rm -rf /var/cache/samba*
sp8-srv-2022 ~ # *mkdir -p /var/lib/samba/sysvol*
sp8-srv-2022 ~ # *cat /etc/sysconfig/network | grep HOSTNAME*
HOSTNAME=sp8-srv-2022.test5.alt
sp8-srv-2022 ~ # *hostname sp8-srv-2022.test5.alt*
sp8-srv-2022 ~ # *domainname test5.alt*
sp8-srv-2022 ~ # *samba-tool domain provision --realm=test5.alt \
--domain test5 --adminpass='Pa$$word' --dns-backend=SAMBA_INTERNAL \
--server-role=dc*
sp8-srv-2022 ~ # *systemctl enable --now samba*
sp8-srv-2022 ~ # *cp /var/lib/samba/private/krb5.conf /etc/krb5.conf*
----

==== Проверка работы домена Samba AD

[source,subs="verbatim,quotes"]
----
sp8-srv-2022 ~ # *samba-tool domain info 127.0.0.1*
Forest           : test5.alt
Domain           : test5.alt
Netbios domain   : TEST5
DC name          : sp8-srv-2022.test5.alt
DC netbios name  : SP8-SRV-2022
Server site      : Default-First-Site-Name
Client site      : Default-First-Site-Name
----

[source,subs="verbatim,quotes"]
----
sp8-srv-2022 ~ # *smbclient -L localhost -U administrator*
Enter TEST5\administrator's password: 

	Sharename       Type      Comment
	---------       ----      -------
	sysvol          Disk      
	netlogon        Disk      
	IPC$            IPC       IPC Service (Samba 4.14.10)
SMB1 disabled -- no workgroup available
----

===== Проверка работы DNS

Убедитесь в наличии `nameserver 127.0.0.1` в /etc/resolv.conf.

[source,subs="verbatim,quotes"]
----
*sp8-srv-2022 ~ # host test5.alt*
test5.alt has address 10.33.33.233
*sp8-srv-2022 ~ # host -t SRV _kerberos._udp.test5.alt.*
_kerberos._udp.test5.alt has SRV record 0 100 88 sp8-srv-2022.test5.alt.
*sp8-srv-2022 ~ # host -t SRV _ldap._tcp.test5.alt.*
_ldap._tcp.test5.alt has SRV record 0 100 389 sp8-srv-2022.test5.alt.
*sp8-srv-2022 ~ # host -t A sp8-srv-2022.test5.alt.*
sp8-srv-2022.test5.alt has address 10.33.33.233
----

===== Проверка работы службы Kerberos 


[source,subs="verbatim,quotes"]
----
*sp8-srv-2022 ~ # kinit administrator*
Password for administrator@TEST5.ALT: 
Warning: Your password will expire in 41 days on Ср 01 июн 2022 14:11:02
*sp8-srv-2022 ~ # klist*
Ticket cache: FILE:/tmp/krb5cc_0
Default principal: administrator@TEST5.ALT

Valid starting       Expires              Service principal
20.04.2022 15:22:03  21.04.2022 01:22:03  krbtgt/TEST5.ALT@TEST5.ALT
	renew until 21.04.2022 15:21:55
----

===== Конфигурация после настройки Samba AD

[source,subs="verbatim,quotes"]
----
*sp8-srv-2022 ~ # cat /etc/samba/smb.conf | grep -viE '(\^#|^$)'*
[global]
	dns forwarder = 10.33.33.1
	netbios name = SP8-SRV-2022
	realm = TEST5.ALT
	server role = active directory domain controller
	workgroup = TEST5
[sysvol]
	path = /var/lib/samba/sysvol
	read only = No
[netlogon]
	path = /var/lib/samba/sysvol/test5.alt/scripts
	read only = No
----

==== Проверка работы Рабочей Станции в домене Samba AD

Вводим ОС Альт 8СП Рабочая станция в домен https://altsp.su/export/sites/altsp/.galleries/documentation/fstek/lknv.11100-01-90-01-rukovodstvo-administratora.pdf, п.9.2. Ввод рабочей станции в домен Active Directory



[source,subs="verbatim,quotes"]
----
*sp8-ws-2022 ~ # getent passwd administrator*
administrator:*:1093200500:1093200513:Administrator:/home/TEST5.ALT/administrator:/bin/bash
*sp8-ws-2022 ~ # net ads info*
LDAP server: 10.33.33.233
LDAP server name: sp8-srv-2022.test5.alt
Realm: TEST5.ALT
Bind Path: dc=TEST5,dc=ALT
LDAP port: 389
Server time: Ср, 20 апр 2022 19:01:00 MSK
KDC server: 10.33.33.233
Server time offset: 0
Last machine account password change: Ср, 20 апр 2022 18:56:42 MSK
*sp8-ws-2022 ~ # net ads testjoin*
Join is OK
----

Проверка работы Kerberos на клиете:
[source,subs="verbatim,quotes"]
----
*sp8-ws-2022 ~ # kinit administrator*
Password for administrator@TEST5.ALT: 
*sp8-ws-2022 ~ # klist*
Ticket cache: KEYRING:persistent:0:0
Default principal: administrator@TEST5.ALT

Valid starting       Expires              Service principal
20.04.2022 19:03:16  21.04.2022 05:03:16  krbtgt/TEST5.ALT@TEST5.ALT
	renew until 27.04.2022 19:03:11
----

WARNING: pve9 ~ # qm snapshot 106 snap009 --description "2fa_samba_full; sp8-ws-2022.test5.alt add to domain"

WARNING: pve9 ~ # qm snapshot 107 snap009 --description "2fa_samba_full; sp8-ws-2022.test5.alt add to domain"

=== Установка и настройка ПО для работы с токенами. На сервере и на клиенте.

Настройка выполняется на обновлённой пакетной базе и последнем ядре из репозитория:
[source,subs="verbatim,quotes"]
----
$ *su-*
# *apt-get update*
# *apt-get dist-upgrade*
# *update-kernel*
# *reboot*
----

После обновления необходимо установить следующие пакеты:
[source,subs="verbatim,quotes"]
----
# *apt-get install librtpkcs11ecp libjcpkcs11 isbc-pkcs11 \*
*opensc pcsc-lite-ccid pcsc-lite pcsc-tools gnutls-utils \*
*libp11 libp11-kit*
----

*librtpkcs11ecp, libjcpksc11, isbc-pkcs11* — библиотеки PKCS#11 вендоров токенов: Актив, 
Аладдин и ISBC соответственно. +
Если каких-то пакетов в репозитории нет или с ними выявлены 
проблемы, необходимо установить их с сайта производителя:

- Актив Рутокен (librtpkcs11ecp): https://www.rutoken.ru/support/download/pkcs/
- Аладдин JaСarta (libjcPKCS11-2): https://www.aladdin-rd.ru/support/downloads/jacarta_client
(теперь ещё и в составе «Единого Клиента JaCarta»)
- ISBC ESMART (libisbc_pkcs11_main): https://esmart.ru/download/

*opensc, pcsc-lite-ccid, pcsc-lite, pcsc-tools, gnutls-utils* —утилиты и библиотеки, необходимые 
для обеспечения работы интерфейсов PC/SC(+CCID) и PKCS#11. +
*libp11* - библиотека для работы с токенами в openssl (openssl engine) +
*libp11-kit* - прокси-библиотека для работы с библиотеками вендоров токенов по протоколу PKCS11

==== Настройка Polkit. На сервере и на клиенте.

По умолчанию Policy Kit позволяет работать с токенами только в активной сессии (после входа в ОС) и только локальному пользователю. Чтобы можно было работать с токенами на этапе логина доменных пользователей, необходимо поменять все запреты "*>no<*" на разрешения "*>yes<*" в файле */usr/share/polkit-1/actions/org.debian.pcsc-lite.policy*.

В итоге конфигурационный файл polkit примет следующий вид:

[source,xml,subs="verbatim,quotes"]
----
# *cat /usr/share/polkit-1/actions/org.debian.pcsc-lite.policy*
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE policyconfig PUBLIC
 "-//freedesktop//DTD PolicyKit Policy Configuration 1.0//EN"
 "http://www.freedesktop.org/standards/PolicyKit/1.0/policyconfig.dtd">
<policyconfig>
  <vendor>The PCSC-lite Project</vendor>
  <vendor_url>https://pcsclite.apdu.fr/</vendor_url>
<!--  <icon_name>smart-card</icon_name> -->
  <action id="org.debian.pcsc-lite.access_pcsc">
    <description>Access to the PC/SC daemon</description>
    <message>Authentication is required to access the PC/SC daemon</message>
    <defaults>
      <allow_any>##**yes**##</allow_any>
      <allow_inactive>##**yes**##</allow_inactive>
      <allow_active>yes</allow_active>
    </defaults>
  </action>
  <action id="org.debian.pcsc-lite.access_card">
    <description>Access to the smart card</description>
    <message>Authentication is required to access the smart card</message>
    <defaults>
      <allow_any>##**yes**##</allow_any>
      <allow_inactive>##**yes**##</allow_inactive>
      <allow_active>yes</allow_active>
    </defaults>
  </action>
</policyconfig>
----

==== Проверка работы PC/SC интерфейса. На сервере и на клиенте.

Работу интерфейса PC/SC обеспечивает служба *pcscd.service*, которая при необходимости 
запускается через одноимённый сокет - *pcscd.socket*.

Включаем pcscd.socket:
[source,subs="verbatim,quotes"]
----
# *systemctl enable --now pcscd.socket*
Created symlink /etc/systemd/system/sockets.target.wants/pcscd.socket → /lib/systemd/system/pcscd.socket.
----

[source,subs="verbatim,quotes"]
----
*sp8-srv-2022 ~ # systemctl status pcscd.socket*
● pcscd.socket - PC/SC Smart Card Daemon Activation Socket
     Loaded: loaded (/lib/systemd/system/pcscd.socket; enabled; vendor preset: enabled)
     Active: [green]#active (listening)# since Wed 2022-04-20 19:20:24 MSK; 13min ago
   Triggers: ● pcscd.service
     Listen: /run/pcscd/pcscd.comm (Stream)
     CGroup: /system.slice/pcscd.socket

апр 20 19:20:24 sp8-srv-2022 systemd[1]: Listening on PC/SC Smart Card Daemon Activation Socket.
----

Убеждаемся, что токен виден в выводе утилиты *pcsc_scan*, запущенной с правами пользователя, и однозначно определяется его модель:

[source,subs="verbatim,quotes"]
----
*user@sp8-srv-2022 ~ $ pcsc_scan -r*
Using reader plug'n play mechanism
[red]#Scanning present readers...#
[blue]#0: Aktiv Rutoken ECP 00 00#
[blue]#1: ESMART Token GOST [ESMART Token] 01 00#
[blue]#2: Aladdin R.D. JaCarta 02 00#
----

Если в выводе команды `*pcsc_scan -r*` вы не видите токенов, то для решения этого вопроса 
обратитесь к документу «Методика тестирования токенов».

WARNING: pve9 ~ # qm snapshot 106 snap010 --description "2fa_samba_full; PC/SC - OK"

WARNING: ve9 ~ # qm snapshot 107 snap010 --description "2fa_samba_full; PC/SC - OK"


==== Проверка работы библиотек вендоров PKCS11. На сервере и на клиенте.

Библиотеки pkcs11 являются основой для работы с токенами и будут использоваться 
всеми компонентами, участвующими в 2ФА. +
В общем виде работа с библиотеками вендоров токенов выглядит следующим образом:

[source,subs="verbatim,quotes"]
----
$ *pkcs11-tool --module _путь_до_библиотеки_вендора_ --list-token-slots*
----

Для каждого токена мы должны получить информацию о нём и о доступных слотах. Если в выводе вышеуказанных команд вы не видите слотов токена, то для решения этого вопроса обратитесь к документу «Методика тестирования токенов».

===== ESMART Token

[source,subs="verbatim,quotes"]
----
*user@sp8-srv-2022 ~ $ pkcs11-tool --module /usr/lib64/libisbc_pkcs11_main.so --list-token-slots*
Available slots:
Slot 0 (0x1): ESMART Token GOST [ESMART Token] 01 00
  token label        : esmart_64
  token manufacturer : ISBC
  token model        : ESMART Token
  token flags        : login required, rng, token initialized, user PIN count low, PIN initialized
  hardware version   : 0.0
  firmware version   : 2.4
  serial num         : 206F6060C102
  pin min/max        : 4/8
----

===== Rutoken ECP

[source,subs="verbatim,quotes"]
----
*user@sp8-srv-2022 ~ $ pkcs11-tool --module /usr/lib64/librtpkcs11ecp.so --list-token-slots*
Available slots:
Slot 0 (0x0): Aktiv Rutoken ECP 00 00
  token label        : Rutoken ECP <no label>
  token manufacturer : Aktiv Co.
  token model        : Rutoken ECP
  token flags        : login required, rng, SO PIN to be changed, token initialized, PIN initialized, user PIN to be changed
  hardware version   : 138.1
  firmware version   : 23.2
  serial num         : 3b088b41
  pin min/max        : 6/32
----

===== JaCarta-2 SE

[source,subs="verbatim,quotes"]
----
*user@sp8-srv-2022 ~ $ pkcs11-tool --module /usr/lib64/libjcPKCS11-2.so --list-token-slots*
Available slots:
Slot 0 (0x1ffff): Aladdin R.D. JaCarta 02 00
  token label        : STANDART.SE
  token manufacturer : Aladdin R.D.
  token model        : JaCarta GOST 2.0
  token flags        : login required, rng, token initialized, PIN initialized, other flags=0x800
  hardware version   : 1.0
  firmware version   : 2.55
  serial num         : 6082023848937678
  pin min/max        : 6/32
Slot 1 (0x2ffff): Aladdin R.D. JaCarta 02 00
  token label        : jc2seLaser
  token manufacturer : Aladdin R.D.
  token model        : JaCarta Laser
  token flags        : login required, token initialized, PIN initialized
  hardware version   : 1.0
  firmware version   : 1.0
  serial num         : 6082023848937678
  pin min/max        : 4/10
----

===== p11-kit-proxy. На сервере.

Для упрощения работы с тремя разными токенами вместо трех библиотек вендоров можно использовать одну - *p11-kit-proxy*. Эта библиотека является промежуточным звеном (прокси) между утилитами (например *pkcs11-tool*) и библиотеками вендоров (например *librtpkcs11ecp.so*). Таким образом, для работы с разными токенами, для которых есть *модуль pkcs11*, можно использовать одну библиотеку. +

WARNING: Обратите внимание, что разные библиотеки pkcs11 по разному присваивают идентификатор слота (он указывается после индекса слота в скобках - #Slot 2 (*0x2ffff*)# )

Чтобы использовать *p11-kit-proxy*, необходимо убедиться что необходимые модули pkcs11 для работы с библиотеками вендоров присутствуют:

[source,subs="verbatim,quotes"]
----
*user@sp8-srv-2022 ~ $ ls /etc/pkcs11/modules/*
isbc.module  jcpkcs11.module  rutokenecp.module
----

Все необходимые модули (*isbc.module, jcpkcs11.module, rutokenecp.module*), для используемых трех токенов, присутствуют. Проверим работу библиотеки p11-kit-proxy:

[source,subs="verbatim,quotes"]
----
*user@sp8-srv-2022 ~ $ pkcs11-tool --module /usr/lib64/p11-kit-proxy.so --list-token-slots*
Available slots:
*Slot 0 (0x10): ESMART Token GOST [ESMART Token] 01 00*
  token label        : esmart_64
  token manufacturer : ISBC
  token model        : ESMART Token
  token flags        : login required, rng, token initialized, user PIN count low, PIN initialized
  hardware version   : 0.0
  firmware version   : 2.4
  serial num         : 206F6060C102
  pin min/max        : 4/8
*Slot 1 (0x12): Aladdin R.D. JaCarta 02 00*
C_GetTokenInfo() failed: rv = unknown PKCS11 error
*Slot 2 (0x13): Aladdin R.D. JaCarta 02 00*
  token label        : jc2seLaser
  token manufacturer : Aladdin R.D.
  token model        : JaCarta Laser
  token flags        : login required, token initialized, PIN initialized
  hardware version   : 1.0
  firmware version   : 1.0
  serial num         : 6082023848937678
  pin min/max        : 4/10
*Slot 3 (0x32): Aktiv Rutoken ECP 00 00*
  token label        : Rutoken ECP <no label>
  token manufacturer : Aktiv Co.
  token model        : Rutoken ECP
  token flags        : login required, rng, SO PIN to be changed, token initialized, PIN initialized, user PIN to be changed
  hardware version   : 138.1
  firmware version   : 23.2
  serial num         : 3b088b41
  pin min/max        : 6/32
----  

Библиотека *p11-kit-proxy.so* показывает все токены и слоты на них в виде общего набора слотов. +  

Ошибка в "Slot 1" связана с тем, что этот слот токена *JaCarta-2 SE* работает только с ГОСТовыми протоколами шифрования и для этого слота требуется библиотека *libjckt2*. Эта библиотека присутствует в пакете *libjcpksc11*, но p11-kit-proxy ничего о ней не знает, так как нет модуля pkcs11 для нее. +
Чтобы это исправить, создадим модуль pkcs11 для библиотеки libjckt2 (в будущих релизах пакета libjcpksc11 модуль для libjckt2 будет присутствовать):

[source,subs="verbatim,quotes"]
----
*user@sp8-srv-2022 ~ $ su -*
Password: 
*sp8-srv-2022 ~ # cat > /etc/pkcs11/modules/jckt2.module <<-EOF*
> module: /usr/lib64/libjckt2.so
> EOF
----

Также создадим символическую ссылку в каталоге `/usr/lib64/pkcs11/` на библиотеку `libjckt2.so`:

[source,subs="verbatim,quotes"]
----
*sp8-srv-2022 ~ # cd /usr/lib64/pkcs11/*
*sp8-srv-2022 pkcs11 # ln -s ../libjckt2.so .*
----

Убедимься что все слоты на всех токенах отображаются корректно:

[source,subs="verbatim,quotes"]
----
*user@sp8-srv-2022 ~ $ pkcs11-tool --module /usr/lib64/p11-kit-proxy.so --list-token-slots*
Available slots:
*Slot 0 (0x10): ESMART Token GOST [ESMART Token] 01 00*
  token label        : esmart_64
  token manufacturer : ISBC
  token model        : ESMART Token
  token flags        : login required, rng, token initialized, user PIN count low, PIN initialized
  hardware version   : 0.0
  firmware version   : 2.4
  serial num         : 206F6060C102
  pin min/max        : 4/8
*Slot 1 (0x12): Aladdin R.D. JaCarta 02 00*
  token label        : STANDART.SE
  token manufacturer : Aladdin R.D.
  token model        : JaCarta GOST 2.0
  token flags        : login required, rng, token initialized, PIN initialized, other flags=0x800
  hardware version   : 1.0
  firmware version   : 2.55
  serial num         : 6082023848937678
  pin min/max        : 6/32
*Slot 2 (0x13): Aladdin R.D. JaCarta 02 00*
  *token label        : jc2seLaser*
  token manufacturer : Aladdin R.D.
  *token model        : JaCarta Laser*
  token flags        : login required, token initialized, PIN initialized
  hardware version   : 1.0
  firmware version   : 1.0
  serial num         : 6082023848937678
  pin min/max        : 4/10
*Slot 3 (0x32): Aktiv Rutoken ECP 00 00*
  token label        : Rutoken ECP <no label>
  token manufacturer : Aktiv Co.
  token model        : Rutoken ECP
  token flags        : login required, rng, SO PIN to be changed, token initialized, PIN initialized, user PIN to be changed
  hardware version   : 138.1
  firmware version   : 23.2
  serial num         : 3b088b41
  pin min/max        : 6/32
----

Для токена JaCarta-2 SE мы будем использовать *Slot 2 (0x13)(token model: JaCarta Laser)*. Только этот слот поддерживает протоколы шифрования RSA в данном токене.

[WARNING]                                                                      
====
Во время настройки 2ФА на клиенте для токена JaCarta-2 SE нам необходимо будет указать конкретный слот, на котором будет находиться сертификат. Служба SSSD (служба аутентификации) будет определять этот слот по метке токена (*token label*). По-умолчанию на токенах JaCarta метки слотов одинаковые.
====

Чтобы установить метку слота необходимо этот слот переинициализировать.

[WARNING]
====
При инициализации слота все данные на нем будут удалены.
====

Проинициализируем *Slot 2 (0x13)* и установим метку *jacarta-slot-laser*:

[source,subs="verbatim,quotes"]
----
*user@sp8-srv-2022 ~ $ pkcs11-tool --module /usr/lib64/p11-kit-proxy.so --init-token \*
*--slot 0x13 --label jacarta-slot-laser*
Please enter the new SO PIN: 
Please enter the new SO PIN (again): 
Token successfully initialized
----

- *SO PIN*	- пин-код администратора
- *0x13*	- идентификатор слота

После инициализации слота необходимо установить пин-код пользователя:

[source,subs="verbatim,quotes"]
----
*user@sp8-srv-2022 ~ $ pkcs11-tool --module /usr/lib64/p11-kit-proxy.so --init-pin \*
*--slot 0x13 --login*
Logging in to "jacarta-slot-laser".
Please enter SO PIN: 
Please enter the new PIN: 
Please enter the new PIN again: 
User PIN successfully initialized
----

Таким же способом можно проинициализировать и установить метки для других слотов.

Теперь слоты будут выглядеть следующим образом:

[source,subs="verbatim,quotes"]
----
*user@sp8-srv-2022 ~ $ pkcs11-tool --module /usr/lib64/p11-kit-proxy.so --list-token-slots*
Available slots:
*Slot 0 (0x11): ESMART Token GOST [ESMART Token] 01 00*
  *token label        : esmart_64*
  token manufacturer : ISBC
  token model        : ESMART Token
  token flags        : login required, rng, token initialized, PIN initialized
  hardware version   : 0.0
  firmware version   : 2.4
  serial num         : 206F6060C102
  pin min/max        : 4/8
*Slot 1 (0x12): Aladdin R.D. JaCarta 00 00*
  token label        : STANDART.SE
  token manufacturer : Aladdin R.D.
  token model        : JaCarta GOST 2.0
  token flags        : login required, rng, token initialized, PIN initialized, other flags=0x800
  hardware version   : 1.0
  firmware version   : 2.55
  serial num         : 6082023848937678
  pin min/max        : 6/32
*Slot 2 (0x13): Aladdin R.D. JaCarta 00 00*
  *token label        : jacarta-slot-laser*
  token manufacturer : Aladdin R.D.
  token model        : JaCarta Laser
  token flags        : login required, token initialized, PIN initialized
  hardware version   : 1.0
  firmware version   : 1.0
  serial num         : 6082023848937678
  pin min/max        : 4/10
*Slot 3 (0x34): Aktiv Rutoken ECP 02 00*
  *token label        : RutokenECP2151*
  token manufacturer : Aktiv Co.
  token model        : Rutoken ECP
  token flags        : login required, rng, SO PIN to be changed, token initialized, PIN initialized, user PIN to be changed
  hardware version   : 138.1
  firmware version   : 23.2
  serial num         : 3b088b41
  pin min/max        : 6/32
----

=== Настройка центра сертификации. На сервере.

Центр сертификации настраиваем на DC, в домашней папке локального пользователя.
Для работы с сертификатами x509 будем использовать Openssl, как наиболее распространённое ПО для этих целей.

Создаем необходимую структуру каталогов CA в домашней папке локального пользователя "user".


[source,subs="verbatim,quotes"]
----
*user@sp8-srv-2022 ~ $ mkdir -pv demoCA/{certs,newcerts,private}*
mkdir: создан каталог 'demoCA'
mkdir: создан каталог 'demoCA/certs'
mkdir: создан каталог 'demoCA/newcerts'
mkdir: создан каталог 'demoCA/private
----


[source,subs="verbatim,quotes"]
----
*user@sp8-srv-2022 ~ $ touch demoCA/index.txt*
*user@sp8-srv-2022 ~ $ echo "01" > demoCA/serial*
----

Генерируем ключ ЦС


[source,subs="verbatim,quotes"]
----
*user@sp8-srv-2022 ~ $ openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:2048 \*
*-outform PEM -out demoCA/private/cakey.pem*
........................................................+++++
..+++++
----

Создаем сертификат ЦС


[source,subs="verbatim,quotes"]
----
*user@sp8-srv-2022 ~ $ openssl req -new -x509 -key demoCA/private/cakey.pem \*
*-out demoCA/certs/cacert.pem -extensions v3_ca -days +3650 \*
*-outform PEM -subj "/C=RU/ST=Moscow/O=TEST5.ALT/CN=CA"*
----

[source,subs="verbatim,quotes"]
----
*user@sp8-srv-2022 ~ $ openssl x509 -in demoCA/certs/cacert.pem -noout -text*
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            0a:fd:96:b5:f0:99:b5:7a:ba:b6:e2:51:53:a2:60:15:60:c3:6a:24
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: C = RU, ST = Moscow, O = TEST5.ALT, CN = CA
        Validity
            Not Before: Apr 21 15:12:36 2022 GMT
            Not After : Apr 18 15:12:36 2032 GMT
        Subject: C = RU, ST = Moscow, O = TEST5.ALT, CN = CA
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                RSA Public-Key: (2048 bit)
                Modulus:
                    00:b4:cd:48:14:d2:01:5b:02:86:69:aa:e3:1d:65:
                    62:4a:33:02:5d:00:7d:c5:04:57:04:57:6a:6f:21:
                    07:3a:dc:af:02:48:85:22:13:0d:0a:3d:f1:33:ba:
                    fb:b7:be:2d:7b:43:41:86:b3:53:33:eb:e2:c5:e3:
                    e4:5d:38:8b:6c:59:eb:ab:80:6a:27:db:2b:43:08:
                    fc:16:7e:dc:bd:e9:a6:29:4b:41:cc:4f:ed:17:96:
                    36:4f:82:9c:11:2f:2b:4d:9b:11:13:5b:3d:a3:fb:
                    7c:f5:42:c6:a5:92:3e:56:5a:d8:bc:59:5a:90:f4:
                    59:f4:8c:20:62:38:f1:46:de:f3:d3:a4:e5:7a:fb:
                    5d:37:bf:e9:71:87:0f:33:89:f8:b7:bf:18:9b:3f:
                    ac:4c:38:97:de:6f:c1:89:3f:29:c1:ce:81:d1:75:
                    11:b3:7e:45:4e:d3:62:de:73:da:0d:d0:e2:55:a5:
                    d1:30:16:4d:b5:4c:83:21:d8:06:b7:cd:91:ab:dd:
                    ca:72:38:da:69:41:50:c6:e8:9c:1b:9e:c7:2c:3b:
                    a6:9b:4a:28:40:bc:a4:14:f5:04:b9:5e:7b:c2:40:
                    7d:fb:7d:5e:76:cf:b3:ea:da:c2:3b:a3:7f:ea:66:
                    15:06:46:d6:1d:df:6c:a6:e6:ad:67:1e:09:cd:19:
                    01:b5
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Subject Key Identifier: 
                15:25:63:DC:3B:CE:70:C7:39:C4:DA:20:9A:9F:D7:08:E3:95:5F:08
            X509v3 Authority Key Identifier: 
                keyid:15:25:63:DC:3B:CE:70:C7:39:C4:DA:20:9A:9F:D7:08:E3:95:5F:08

            X509v3 Basic Constraints: 
                CA:TRUE
    Signature Algorithm: sha256WithRSAEncryption
         aa:b1:ec:63:b2:9d:12:e8:ad:56:a0:9d:d3:f4:26:c4:7e:c4:
         b5:36:64:da:5b:59:49:aa:26:c1:74:30:cb:28:83:97:17:69:
         7c:1e:f8:3c:8a:cf:08:a8:81:56:b1:37:0f:1d:33:d3:db:e2:
         b2:2c:3f:49:2d:93:19:b9:d6:6e:f5:9b:1c:86:d5:cf:0a:08:
         b5:17:51:82:bb:67:0e:0e:ee:80:b6:36:56:04:f6:2c:c1:d6:
         4c:23:6a:51:da:aa:8d:5f:20:06:88:2d:48:c0:ec:3b:c4:28:
         97:1d:5b:dd:88:f9:0b:f4:1d:4c:d4:39:e7:20:a2:b0:69:5e:
         f8:70:2a:3b:2e:71:e2:fc:0e:d3:f8:02:11:b3:61:c3:94:91:
         70:3c:a3:3d:c7:d7:86:c0:94:f9:53:a4:61:e1:07:b9:58:0a:
         c4:4f:6e:a8:fa:b7:4b:8f:9e:64:66:6a:2e:71:b9:d6:8d:7c:
         6a:c1:2c:30:8c:51:90:32:4e:d1:45:98:36:a9:4f:0d:be:91:
         76:7f:2e:da:68:65:1d:9d:04:1f:c5:06:de:8d:8d:38:6b:2b:
         b1:28:99:b4:a4:40:45:68:f9:03:4f:f2:89:5b:ac:ca:6c:83:
         17:57:85:e0:f7:c5:1d:51:e7:6a:9f:19:fd:3f:2c:7e:bd:39:
         44:48:94:5a
----

Генерируем ключ KDC (Key Distribution Center)

[source,subs="verbatim,quotes"]
----
*user@sp8-srv-2022 ~ $ openssl genrsa -out demoCA/private/dc-key.pem 2048*
Generating RSA private key, 2048 bit long modulus (2 primes)
...................+++++
........+++++
e is 65537 (0x010001)
----

Создаем запрос на выдачу сертификата для KDC

[source,subs="verbatim,quotes"]
----
*user@sp8-srv-2022 ~ $ openssl req -new -out demoCA/dc-req.csr -key demoCA/private/dc-key.pem \*
*-subj "/C=RU/ST=Moscow/O=TEST5.ALT/CN=sp8-srv-2022.test5.alt"*
----

[WARNING]
====
pve9 ~ # qm snapshot 106 snap012 --description "2fa_samba_full; gen cert req for KDC - OK"
pve9 ~ # qm snapshot 107 snap012 --description "2fa_samba_full; gen cert req for KDC - OK"
====


Создаем файл расширений (extensions) сертификата для KDC


[source,subs="verbatim,quotes"]
----
*user@sp8-srv-2022 ~ $ cat demoCA/extension_file_KDC*
[kdc_cert]
basicConstraints=CA:FALSE
keyUsage=nonRepudiation,digitalSignature,keyEncipherment,keyAgreement
extendedKeyUsage=1.3.6.1.5.2.3.5
subjectKeyIdentifier=hash
authorityKeyIdentifier=keyid,issuer
issuerAltName=issuer:copy
subjectAltName=otherName:1.3.6.1.5.2.2;SEQUENCE:kdc_princ_name

[kdc_princ_name]
realm=EXP:0,GeneralString:${ENV::REALM}
principal_name=EXP:1,SEQUENCE:kdc_principal_seq

[kdc_principal_seq]
name_type=EXP:0,INTEGER:1
name_string=EXP:1,SEQUENCE:kdc_principals

[kdc_principals]
princ1=GeneralString:krbtgt
princ2=GeneralString:${ENV::REALM}
----

По умолчанию подключаемый модуль PKINIT Kerberos ожидает, что сертификат KDC содержит EKU (extendedKeyUsage) id-pkinit-KPKdc (OID 1.3.6.1.5.2.3.5), как определено в RFC 4556, и имеет имя хоста KDC в id-pkinit-san (OID 1.3.6.1.5.2.2), как определено в RFC4556.

extendedKeyUsage = 1.3.6.1.5.2.3.5 - указывает что сертификат выпускается для KDC (id-pkinit-KPKdc, https://oidref.com/1.3.6.1.5.2.3.5)
subjectAltName=otherName:1.3.6.1.5.2.2;SEQUENCE:kdc_princ_name,DNS:dc2.test2.alt - здесь указываем Kerberos principalname и DNS KDC (id-pkinit-san, https://oidref.com/1.3.6.1.5.2.2)
Kerberos principalname формируется сложным образом - kdc_principals + kdc_principal_seq + kdc_princ_name.


Выпускаем сертификат для KDC

[source,subs="verbatim,quotes"]
----
*user@sp8-srv-2022 ~ $ env REALM=TEST5.ALT openssl ca -batch -in demoCA/dc-req.csr \*
*-out demoCA/certs/dc-cert.pem -cert demoCA/certs/cacert.pem \*
*-extfile demoCA/extension_file_KDC -extensions kdc_cert*
Using configuration from /var/lib/ssl/openssl.cnf
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number: 1 (0x1)
        Validity
            Not Before: Apr 21 15:56:40 2022 GMT
            Not After : Apr 21 15:56:40 2023 GMT
        Subject:
            countryName               = RU
            stateOrProvinceName       = Moscow
            organizationName          = TEST5.ALT
            commonName                = sp8-srv-2022.test5.alt
        X509v3 extensions:
            X509v3 Basic Constraints: 
                CA:FALSE
            X509v3 Key Usage: 
                Digital Signature, Non Repudiation, Key Encipherment, Key Agreement
            X509v3 Extended Key Usage: 
                Signing KDC Response
            X509v3 Subject Key Identifier: 
                69:9D:C6:7D:BB:37:7B:5A:80:55:CB:AB:98:58:23:03:0E:8C:0B:55
            X509v3 Authority Key Identifier: 
                keyid:15:25:63:DC:3B:CE:70:C7:39:C4:DA:20:9A:9F:D7:08:E3:95:5F:08

            X509v3 Issuer Alternative Name: 
                <EMPTY>

            X509v3 Subject Alternative Name: 
                othername:<unsupported>
Certificate is to be certified until Apr 21 15:56:40 2023 GMT (365 days)

Write out database with 1 new entries
Data Base Updated
----

=== Выпускаем сертификаты для пользователей

==== Генерируем ключевую пару на токенах

==== Генерируем запрос на сертификат

===== openssl engine

==== Выпускаем сертификаты

==== Записываем сертификаты на токены

=== Настройка TLS службы Samba DC








== !!!!!!!!!!!!!!!!!!!!!!!



=== Создаем пользователей в домене FreeIPA

Создадим 3х пользователей для 3х токенов. Перед работой с утилитой *ipa* необходимо получить билет Kerberos администратора домена.

[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *kinit admin*
Password for admin@TEST3.ALT:
----

для Рутокен ECP
[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *ipa user-add rt --first=Active --last=Rutoken*
---------------
Added user "rt"
---------------
  User login: rt
  First name: Active
  Last name: Rutoken
  Full name: Active Rutoken
  Display name: Active Rutoken
  Initials: AR
  Home directory: /home/rt
  GECOS: Active Rutoken
  Login shell: /bin/bash
  Principal name: rt@TEST3.ALT
  Principal alias: rt@TEST3.ALT
  Email address: rt@test3.alt
  UID: 1450000001
  GID: 1450000001
  Password: *False*
  Member of groups: ipausers
  Kerberos keys available: False
----

для JaCarta-2 SE
[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *ipa user-add jc --first=Aladdin --last=Jacarta*
---------------
Added user "jc"
---------------
  User login: jc
  First name: Aladdin
  Last name: Jacarta
  Full name: Aladdin Jacarta
  Display name: Aladdin Jacarta
  Initials: AJ
  Home directory: /home/jc
  GECOS: Aladdin Jacarta
  Login shell: /bin/bash
  Principal name: jc@TEST3.ALT
  Principal alias: jc@TEST3.ALT
  Email address: jc@test3.alt
  UID: 1450000003
  GID: 1450000003
  Password: *False*
  Member of groups: ipausers
  Kerberos keys available: False
----

для ESMART Token
[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *ipa user-add es --first=ISBC --last=ESMART*
---------------
Added user "es"
---------------
  User login: es
  First name: ISBC
  Last name: ESMART
  Full name: ISBC ESMART
  Display name: ISBC ESMART
  Initials: IE
  Home directory: /home/es
  GECOS: ISBC ESMART
  Login shell: /bin/bash
  Principal name: es@TEST3.ALT
  Principal alias: es@TEST3.ALT
  Email address: es@test3.alt
  UID: 1450000004
  GID: 1450000004
  Password: *False*
  Member of groups: ipausers
  Kerberos keys available: False
----

Обратите внимание, что для созданных пользователей не установлен пароль. Устанавливать его смысла нет, так как аутентификация будет производиться по сертификату на токене.

=== Центр сертификации (ЦС) и Key Distribution Center (KDC)

Так как установка производилась с интегрированным ЦС, то на сервере уже присутствует его сертификат, равно как и сертификат KDC. +
В процессе PKINIT задействована следующая цепочка сертификатов: +
*сертификат ЦС - сертификат KDC - сертификат клиента* +
На сервере используется сертификат ЦС и сертификат KDC. На клиенте используется сертификат ЦС и сертификат клиента (на токене). +

Сертификат ЦС на сервере находится в базе NSS. Его нужно экспортировать, чтобы перенести на ПК клиента. Для этого необходимо знать его серийный номер в базе NSS. +

Определим серийный номер сертификата ЦС:
[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *ipa cert-find | grep -i \
'Subject: CN=Certificate Authority,O=TEST3.ALT' -A4*
  Subject: CN=Certificate Authority,O=TEST3.ALT
  Issuer: CN=Certificate Authority,O=TEST3.ALT
  Not Before: Tue Mar 22 19:06:38 2022 UTC
  Not After: Sat Mar 22 19:06:38 2042 UTC
  Serial number: *1*
----

Экспортируем сертификат ЦС в файл *ca.pem* для последующего переноса на ПК клиента:
[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *ipa cert-show 1 --certificate-out=ca.pem*
  Issuing CA: ipa
  Certificate: MIIEhTCCAu2gAwIBAgIBATANBgkqhkiG9w0BAQsFADA0MRIwEAYDVQQKDAlURVNUMy5BTFQxHjAcBgNVBAMMFUNlcnRpZmljYXRlIEF1dGhvcml0eTAeFw0yMjAzMjIxNjA2MzhaFw00MjAzMjIxNjA2MzhaMDQxEjAQBgNVBAoMCVRFU1QzLkFMVDEeMBwGA1UEAwwVQ2VydGlmaWNhdGUgQXV0aG9yaXR5MIIBojANBgkqhkiG9w0BAQEFAAOCAY8AMIIBigKCAYEAuK1ItgX18UgpSR2jeiSNxJB4TvF3dthUfdSIJgnP5dlXxcOaTs5W/C1SoEcyn3GuuSRuZpbxhSE0ng2PCGD+jlIsYhdF+fzS72N2XTz3Srki8uoNBFnY1PFt0smDOSOKkHq50W8ymOrLJlqExGoNwpbRoKuwdB/DxuMYOkycCls6MwlcJKy1T+YzO6zptvueg2l2NGn4oLH1l/mUpTE2kgJe311dn30wqVt2nCoywMut/3d8Ew/7OuTUriaUykWsKPl6z3zKP2Z5ZJbJA+bjVncvYw5b0LSHyVt7JkaGfBhqH5QdjHyRIahgAk2ZpCNzmN9usLp+gkPiK2xgYrvjyEACmwDNNFEX/3QkhoVOjZjN7Lh5P0okpXizz7HyGEyDBQjBwn1P2iNvW6IUSbdvv1eGdYrh4IY12NlZml0MmI7iaAsQpFgNUFG6yMMbhR/oFte3rSNwBVd2KqgDm9YByZ46AS5g1rcDbN+YOagQFrhVVqdt7yQt+USXxiwUD7hTAgMBAAGjgaEwgZ4wHwYDVR0jBBgwFoAU0WzZal5XQlVEDShruukh21AO3n0wDwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMCAcYwHQYDVR0OBBYEFNFs2WpeV0JVRA0oa7rpIdtQDt59MDsGCCsGAQUFBwEBBC8wLTArBggrBgEFBQcwAYYfaHR0cDovL2lwYS1jYS50ZXN0My5hbHQvY2Evb2NzcDANBgkqhkiG9w0BAQsFAAOCAYEAoocqsyLTgCQIrIjv5Q/9s0fZ210wA7xyV2KiXsVS3jS61CleBsqwjV6imyVZto6mcknBt7AdhYUYOv2FjguctWTSFeVVGekkzfmHGyz0lCdCBbX146ZUVygimG88ZXqEHNmbYlZTr1RUJC/AYOnhNZlkqIIi1nR53HTfpuF1t3tq+XcWpDr1Jq9/mA7hhQl/k+ZO5D0CM/Fx8bisW+vtYYvYb06fRIN+Eeggo58R4ENO7rK7kqJ1X8wQ+nbXSo/FqslmCW/vth9MFghcvqCoFlw46JPWFPrGle5OydmNqmJIrr1AWPsKPs196hseLj2E0S+hwE5hhLxxgIdMr4RldPjhWBCZ3go5pxuAMYNf0GQMQfpY0AfAtQRT1JDtr86YA51uzbPrZd+U6g/VDPyd6qGs9pF1nMYe6HBxlF7xvDUDe8whJyiQo/HhyuM8E805/7Mv3U2LLE19u+CwA6VWa/HGvEc9a33zX9tcd0BhPsfjoWyMt97T6kRgxWvVDKz3
  Subject: CN=Certificate Authority,O=TEST3.ALT
  Issuer: CN=Certificate Authority,O=TEST3.ALT
  Not Before: Tue Mar 22 16:06:38 2022 UTC
  Not After: Sat Mar 22 16:06:38 2042 UTC
  Serial number: 1
  Serial number (hex): 0x1
  Revoked: False
----

Сертификат KDC можно просмотреть следующей командой:

[source,subs="verbatim,quotes"]
----
ipa-sp8srv211221 ~ # *ipa-getcert list*
...
Request ID '20220322160917':
        status: MONITORING
        stuck: no
        key pair storage: type=FILE,location='/var/lib/kerberos/krb5kdc/kdc.key'
        certificate: type=FILE,location='/var/lib/kerberos/krb5kdc/kdc.crt'
        CA: IPA
        issuer: CN=Certificate Authority,O=TEST3.ALT
        subject: CN=ipa-sp8srv211221.test3.alt,O=TEST3.ALT
        expires: 2024-03-22 19:09:17 MSK
        principal name: krbtgt/TEST3.ALT@TEST3.ALT
        key usage: digitalSignature,nonRepudiation,keyEncipherment,dataEncipherment
        *eku: id-kp-serverAuth,id-pkinit-KPKdc*
        pre-save command:
        post-save command: /usr/libexec/ipa/certmonger/renew_kdc_cert
        track: yes
        auto-renew: yes
----

Обратите внимание на EKU (Extended Key Usage). Здесь указано, что данный сертификат может использоваться для аутентификации на сервере (*id-kp-serverAuth*, http://oid-info.com/get/1.3.6.1.5.5.7.3.1), а также имеет ключ (*id-pkinit-KPKdc*, http://oid-info.com/get/1.3.6.1.5.2.3.5), который ожидает Kerberos от KDC для PKINIT.

Также можно посмотреть что PKINIT поддерживается на сервере изначально и готов к работе:
[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *ipa pkinit-status*
----------------
1 server matched
----------------
  Server name: ipa-sp8srv211221.test3.alt
  PKINIT status: *enabled*
----------------------------
Number of entries returned 1
----------------------------
----


=== Выпускаем сертификаты для пользователей

Перед выпуском сертификатов необходимо сгенерировать ключевую пару на токене. Перед генерирацией необходимо определить механизмы шифрования поддерживаемые конкретным токеном. +
Просмотреть механизмы можно при помощи утилиты pkcs11-tool. +

Пример для JaCarta-2 SE. В этом токене 3 слота. Нас интересует 3й, в котором поддерживается протокол RSA.

[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *pkcs11-tool --module /usr/lib64/p11-kit-proxy.so --list-mechanisms \
--token-label JC2SE-Laser*
Supported mechanisms:
  *RSA-PKCS-KEY-PAIR-GEN, keySize={1024,2048}, hw, generate_key_pair*
  RSA-PKCS, keySize={1024,2048}, hw, encrypt, decrypt, sign, verify, wrap, unwrap
  SHA1-RSA-PKCS, keySize={1024,2048}, sign, verify
  RSA-PKCS-OAEP, keySize={1024,2048}, hw, encrypt, decrypt, wrap, unwrap
  SHA256-RSA-PKCS, keySize={1024,2048}, sign, verify
  SHA384-RSA-PKCS, keySize={1024,2048}, sign, verify
  SHA512-RSA-PKCS, keySize={1024,2048}, sign, verify
  DES2-KEY-GEN, keySize={128,128}, generate
  DES3-KEY-GEN, keySize={192,192}, generate
  DES3-ECB, keySize={24,24}, encrypt, decrypt
  DES3-CBC, keySize={24,24}, encrypt, decrypt
  DES3-MAC, keySize={24,24}, sign, verify
  DES3-MAC-GENERAL, keySize={24,24}, sign, verify
  MD5, digest
  MD5-HMAC, sign, verify
  SHA-1, digest
  SHA-1-HMAC, sign, verify
  SHA256, digest
  SHA256-HMAC, sign, verify
  SHA224, digest
  SHA384, digest
  SHA384-HMAC, sign, verify
  SHA512, digest
  SHA512-HMAC, sign, verify
  TLS-PRE-MASTER-KEY-GEN, hw, generate
  TLS-MASTER-KEY-DERIVE, hw, derive
  TLS-KEY-AND-MAC-DERIVE, hw, derive
  TLS-MASTER-KEY-DERIVE-DH, hw, derive
  mechtype-0x378, hw, derive
  mechtype-0x500, hw, sign
  AES-KEY-GEN, keySize={16,32}, generate
  AES-ECB, keySize={16,32}, encrypt, decrypt
  AES-CBC, keySize={16,32}, encrypt, decrypt
  AES-MAC, keySize={16,32}, sign, verify
  AES-MAC-GENERAL, keySize={16,32}, sign, verify
----

Слот JC2SE-Laser на JaCarta-2 SE поддерживает генерацию ключевой пары длиной 1024 и 2048 бит (RSA-PKCS-KEY-PAIR-GEN).

==== Генерируем ключевую пару на токенах

Подключаем токен по одному и генерируем ключевую пару.

для Рутокен ECP
[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *pkcs11-tool --module /usr/lib64/p11-kit-proxy.so --pin 12345678 \
--login --keypairgen --key-type rsa:2048 --id 7001 --label rt_2fa_ipa*
Using slot 32 with a present token (0x30)
Key pair generated:
Private Key Object; RSA
  label:      rt_2fa_ipa
  ID:         7001
  Usage:      decrypt, sign, unwrap
  Access:     sensitive, always sensitive, never extractable, local
Public Key Object; RSA 2048 bits
  label:      rt_2fa_ipa
  ID:         7001
  Usage:      encrypt, verify, wrap
  Access:     local
----
  
для ESMART Token
[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *pkcs11-tool --module /usr/lib64/p11-kit-proxy.so --pin 12345678 \
--login --keypairgen --key-type rsa:2048 --id 7002 --label es_2fa_ipa*
Using slot 0 with a present token (0x10)
Key pair generated:
Private Key Object; RSA
  label:      es_2fa_ipa
  ID:         7002
  Usage:      decrypt, sign, unwrap
  Access:     sensitive, always sensitive, never extractable, local
Public Key Object; RSA 2048 bits
  label:      es_2fa_ipa
  ID:         7002
  Usage:      encrypt, verify, wrap
  Access:     local
----

для JaCarta-2 SE
[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *pkcs11-tool --module /usr/lib64/p11-kit-proxy.so --pin 11111111 \
--login --keypairgen --key-type rsa:2048 --id 7003 --label jc_2fa_ipa --token-label JC2SE-Laser*
Key pair generated:
Private Key Object; RSA
  label:      jc_2fa_ipa
  ID:         7003
  Usage:      decrypt, sign, unwrap
warning: PKCS11 function C_GetAttributeValue(ALWAYS_AUTHENTICATE) failed: rv = CKR_ATTRIBUTE_TYPE_INVALID (0x12)

  Access:     sensitive, always sensitive, never extractable, local
Public Key Object; RSA 2048 bits
  label:      jc_2fa_ipa
  ID:         7003
  Usage:      encrypt, verify, wrap
  Access:     local
----

Утилита pkcs11-tool при работе с токенами JaCarta иногда выдает предупреждение "warning: PKCS11 function ...". Данное предупреждение ошибкой не является и на работоспособность не влияет.

==== Генерируем запрос на сертификат

Теперь, имея закрытые и открытые ключи, создадим запросы на сертификаты. +

Создадим файл-шаблон для выпуска сертификатов пользователей:
[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *cat user_cert.inf*
[ req ]
prompt = no
encrypt_key = no

distinguished_name = dn
req_extensions = exts

[ dn ]
commonName = ${ENV::NAME}

[ exts ]
subjectAltName=email:${ENV::NAME}@test3.alt
----

${ENV::NAME} - переменная, в которую будем передавать имя пользователя сертификата.

===== openssl engine

Генерировать запрос на выдачу сертификат будем при помощи *openssl*. +
Для выпуска сертификата пользователя openssl должен «попросить» токен подписать запрос на выпуск сертификата при помощи приватного ключа, который находится на токене, и доступа к которому ни у кого нет, кроме самого токена. Но *openssl* не умеет напрямую общаться к токенам по протоколу PKCS#11. Чтобы *openssl* cмог передать токену «просьбу» о подписании запроса на сертификат, необходимо использовать так называемый «*engine*». +
*Engine* — это некий механизм, своего рода прокси, который позволяет *openssl* переложить криптофункции на «чужие плечи». В данном случае на стороннюю библиотеку PKCS#11. А уже она, в свою очередь, умея общаться с токеном, сможет донести «просьбу» о подписании запроса на сертификат.

Если в системе установлены пакеты *libp11* и *libp11-kit*, а они уже установлены, *openssl engine* работает без дополнительной конфигурации.

Проверим что engine нам доступен:

[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *openssl engine pkcs11 -t*
(pkcs11) pkcs11 engine
     *[ available ]*
----

Проверим что для engine pkcs11 доступен протокол шифрования RSA:

[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *openssl engine pkcs11 -c*
(pkcs11) pkcs11 engine
 *[RSA, rsaEncryption, id-ecPublicKey]*
----

Подключаем токены по одному и создаем запросы на сертификаты:

для пользователя *rt* (токен Рутокен ECP)
[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *export NAME="#rt#"; openssl req -new -out #rt.csr# -keyform engine \*
*-engine pkcs11 -key "pkcs11:object=#rt_2fa_ipa#" -passin pass:12345678 -config user_cert.inf*
----

- *export NAME="rt"* - передаем в файл-шаблон для выпуска сертификатов имя пользователя
- #*rt.csr*# - файл запроса на выдачу сертификата +
- #*rt_2fa_ipa*# - метка, по которой openssl определяет какими ключами на токене подписывать запрос
- *-passin pass:12345678* - пин-код токена

для пользователя *es* (токен ESMART Token)
[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *export NAME="es"; openssl req -new -out es.csr -keyform engine \*
*-engine pkcs11 -key "pkcs11:object=es_2fa_ipa" -passin pass:12345678 -config user_cert.inf*
engine "pkcs11" set.
----

для пользователя *jc* (токен JaCarta-2 SE)

[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *export NAME="jc"; openssl req -new -out jc.csr -keyform engine \
-engine pkcs11 -key "pkcs11:model=JaCarta%20Laser;object=jc_2fa_ipa" \
-passin pass:11111111 -config user_cert.inf*
engine "pkcs11" set.
----

Здесь, для openssl engine, определяем с каким именно слотом нужно работать при помощи *pkcs11:<URL>*, в котором указываем модель слота - *model=JaCarta%20Laser* (%20 - кодировка пробела). Также для определения слота можно как и раньше использовать его метку. Тогда *pkcs11:<URL>* будет выглядеть так:

[source,subs="verbatim,quotes"]
----
*"pkcs11:token=JC2SE-Laser;object=jc_2fa_ipa"*
----

Получившийся запрос на сертификат, на примере пользователя *rt*:
[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *openssl req -in rt.csr -noout -text*
Certificate Request:
    Data:
        Version: 1 (0x0)
        Subject: *CN = rt*
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                RSA Public-Key: (2048 bit)
                Modulus:
                    00:e2:c7:28:b7:38:b2:f5:e9:bf:1d:c6:57:51:58:
                    83:cb:59:50:ed:59:2e:72:06:dc:a2:3c:9c:3b:6a:
                    4a:ce:d1:5b:a1:cf:bf:84:8b:6f:34:3e:7b:9b:b2:
                    3b:ff:ab:58:76:38:a6:75:61:b1:c9:86:e4:1a:c8:
                    b9:3e:24:f0:53:ce:7e:00:12:80:11:1d:47:d6:53:
                    75:c8:66:d4:85:d4:5b:bf:b9:d4:d1:8b:50:0d:21:
                    ea:0a:ca:e4:8b:d8:04:22:cf:6d:7b:76:c5:3d:65:
                    f9:de:d7:96:d6:4e:e7:49:08:74:09:d8:24:cb:0e:
                    d6:15:fe:68:5a:a5:2c:28:c4:db:2b:04:02:8b:1a:
                    0b:f8:c5:95:cf:23:d0:10:d5:a0:3f:66:03:f5:14:
                    57:9d:1f:39:33:87:cf:55:0e:e3:10:96:91:d1:39:
                    70:d2:e6:31:43:86:c0:bd:00:c6:5c:b2:57:ad:b7:
                    2a:6b:df:f8:5c:6d:0a:09:26:63:99:13:6f:0d:b4:
                    02:9b:ff:5e:44:a8:81:64:b7:ea:9a:97:3e:23:b0:
                    d0:58:b1:6e:c4:67:d6:c9:41:5d:6b:86:8b:50:2e:
                    3f:04:74:4d:54:dd:4c:03:c1:81:53:0d:16:88:0d:
                    2e:2c:94:bd:e5:7b:4f:e1:93:de:b1:54:ed:bc:94:
                    d7:93
                Exponent: 65537 (0x10001)
        Attributes:
        Requested Extensions:
            X509v3 Subject Alternative Name:
                email: *rt@test3.alt*
    Signature Algorithm: sha256WithRSAEncryption
         55:d4:1e:31:72:4a:1e:4e:02:3f:a6:32:64:7b:23:5b:6b:9b:
         a7:ad:fa:4d:21:7f:1c:9c:ee:d9:2b:fa:ac:cd:de:ed:a3:58:
         d2:ee:1d:31:91:e0:08:a2:dc:eb:78:3a:8d:e2:cc:10:0a:f5:
         dd:c8:0a:00:6c:32:c6:cd:3e:e7:83:c5:92:44:d1:8d:a0:e0:
         f0:37:34:64:12:4b:93:d8:c4:2b:e4:ac:83:26:65:42:69:3e:
         1f:2d:62:f2:da:6b:47:13:26:24:57:c9:96:31:3c:e0:f7:a2:
         34:4f:c2:3b:49:e0:f4:f1:d6:93:5e:9e:4e:c3:c1:98:97:66:
         e9:a9:7a:5e:ba:8d:86:f4:95:d6:86:79:da:37:2a:85:5d:e8:
         0e:1f:37:d3:b4:52:5c:c2:c8:c7:bb:69:20:5b:5f:1d:48:65:
         6a:48:c6:a3:14:4d:18:79:ed:46:0f:09:10:ed:11:3d:e8:b3:
         e8:47:d9:87:2a:f5:04:08:be:e0:ff:e8:81:da:b5:63:a8:a7:
         67:c7:89:13:c3:b1:29:e3:88:26:92:d5:c0:5d:61:d7:7c:40:
         8b:9e:2e:03:42:90:db:4f:d1:4f:7e:70:2a:0a:d3:a3:9e:20:
         54:a1:87:7b:c7:66:65:6a:96:c2:25:a3:ca:4e:4e:34:1b:17:
         ab:96:df:b7
----

WARNING: vm195(snap005) vm196(snap005)

WARNING: qm snapshot 195 snap0031 --description "2fa_ipa; OK - gen cert req for JC2SE (old, 3 slots) only"

WARNING: qm snapshot 196 snap0031 --description "2fa_ipa; OK - gen cert req for JC2SE (old, 3 slots) only"


==== Выпускаем сертификаты

Теперь, когда у нас есть файлы-запросы, выпускаем собственно сами сертификаты. Выпущенные сертификаты сохраняются в профиле соответствующего пользователя, в базе LDAP.

Получаем билет Kerberos для выпуска сертификата на сервере, если он не был получен ранее:

[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *kinit admin*
Password for admin@TEST3.ALT:
user@ipa-sp8srv211221 ~ $ *klist*
Ticket cache: KEYRING:persistent:500:500
Default principal: admin@TEST3.ALT

Valid starting       Expires              Service principal
03/30/2022 15:32:47  03/31/2022 15:32:43  krbtgt/TEST3.ALT@TEST3.ALT
----

выпускаем сертификат для пользователя *rt* (токен Рутокен ECP)
[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *ipa cert-request rt.csr --principal rt*
  Issuing CA: ipa
  *Certificate: MIIEkTCCAvmgAwIBAgIBCzANBgkqhkiG9w0BAQsFADA0MRIwEAYDVQQKDAlURVNUMy5BTFQxHjAcBgNVBAMMFUNlcnRpZmljYXRlIEF1dGhvcml0eTAeFw0yMjAzMzAxMjQ4NTVaFw0yNDAzMzAxMjQ4NTVaMCExEjAQBgNVBAoMCVRFU1QzLkFMVDELMAkGA1UEAwwCcnQwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDixyi3OLL16b8dxldRWIPLWVDtWS5yBtyiPJw7akrO0Vuhz7+Ei280Pnubsjv/q1h2OKZ1YbHJhuQayLk+JPBTzn4AEoARHUfWU3XIZtSF1Fu/udTRi1ANIeoKyuSL2AQiz217dsU9Zfne15bWTudJCHQJ2CTLDtYV/mhapSwoxNsrBAKLGgv4xZXPI9AQ1aA/ZgP1FFedHzkzh89VDuMQlpHROXDS5jFDhsC9AMZcslettypr3/hcbQoJJmOZE28NtAKb/15EqIFkt+qalz4jsNBYsW7EZ9bJQV1rhotQLj8EdE1U3UwDwYFTDRaIDS4slL3le0/hk96xVO28lNeTAgMBAAGjggE/MIIBOzAfBgNVHSMEGDAWgBTRbNlqXldCVUQNKGu66SHbUA7efTA7BggrBgEFBQcBAQQvMC0wKwYIKwYBBQUHMAGGH2h0dHA6Ly9pcGEtY2EudGVzdDMuYWx0L2NhL29jc3AwDgYDVR0PAQH/BAQDAgTwMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjB0BgNVHR8EbTBrMGmgMaAvhi1odHRwOi8vaXBhLWNhLnRlc3QzLmFsdC9pcGEvY3JsL01hc3RlckNSTC5iaW6iNKQyMDAxDjAMBgNVBAoMBWlwYWNhMR4wHAYDVQQDDBVDZXJ0aWZpY2F0ZSBBdXRob3JpdHkwHQYDVR0OBBYEFCFX+7558EUtkCOET2oPWR17nTy3MBcGA1UdEQQQMA6BDHJ0QHRlc3QzLmFsdDANBgkqhkiG9w0BAQsFAAOCAYEAXSzbY7CrpoI1Tv6Ejmsvan545DU+2FXICE9vUFlP9601yUU4HNRQobPc8huSBkqZUkdAtERHBUZ/JrwY777+G/J8S1au6SiDK9LwuRwABTV7jJ3hhWB7qxTrWhu1ErdoCToN1kRsek5W/ske+LWM/Ubx9q2vdW/eUjK69GtwbLAWgWZFA1U7PfpDrhk1RPJ7RPPU+o0qToKhz/02JZRsZOZE1/KR5hpGcgOWeE0cG2aAIDxGu4wN2KlHqY4bcefIiLLnwXyZ1Z3jhwYa4A/0qlhqUN7wn3lve/+MctFzh7HA3ULt+egUz8q8Ub1BfN33i1nbdFtxbK6LllJaszxtILIMpu62XeZt33qMpm4ZvuiEJRTF3ewz+lhWYJwLoZLgxHLhtjbht2/Xebd4i2g31jsMusJ556Yq0chpFEw293q+FXjpbHJGiCtgUEsVU77ufKD7+gmqjMGZTkPyvlhZDaXZpKkZeAtXcH39yOs0w6haTBMSFA+HszrseRkSVV2u*
  Subject: CN=rt,O=TEST3.ALT
  Subject email address: rt@test3.alt
  Issuer: CN=Certificate Authority,O=TEST3.ALT
  Not Before: Wed Mar 30 12:48:55 2022 UTC
  Not After: Sat Mar 30 12:48:55 2024 UTC
  *Serial number: 11*
  Serial number (hex): 0xB
----

выпускаем сертификат для пользователя *es* (токен ESMART Token)
[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *ipa cert-request es.csr --principal es*
  Issuing CA: ipa
  *Certificate: MIIEkDCCAvigAwIBAgIBDDANBgkqhkiG9w0BAQsFADA0MRIwEAYDVQQKDAlURVNUMy5BTFQxHjAcBgNVBAMMFUNlcnRpZmljYXRlIEF1dGhvcml0eTAeFw0yMjAzMzAxMjU1NTNaFw0yNDAzMzAxMjU1NTNaMCExEjAQBgNVBAoMCVRFU1QzLkFMVDELMAkGA1UEAwwCZXMwggEhMA0GCSqGSIb3DQEBAQUAA4IBDgAwggEJAoIBAHB7rEXrujSWW3OmUWqHXDxbFKNFU2j76pRQmK+5UbnnopoWfY6qGdb3EiYXnf9bBn1J06QU0FuDS8vZhNqYeb6Oc3zMKWMHtK+0EJXx/9BA+X7Yu8TsvKEAPKqHE8s44BsF/SYCyQ3Psoo550hDEnoy8b/gl2r8bs6YnFXns5sYDvL2O8frNtrN36jZIyqo7cE+OU+AXYyId+iXEnWEhUzoNeRAhoA6BV/gnnjsBdE7xkR2WoM6tlFROP5cXbL3rS/pwWR35uQlevgrrijnQS2a0ZJQ4pITm2wseefe0e0fyZwP+ot0xtENIRK2Ks08J70X21lDaIIQEPtdNzpYpo8CAwEAAaOCAT8wggE7MB8GA1UdIwQYMBaAFNFs2WpeV0JVRA0oa7rpIdtQDt59MDsGCCsGAQUFBwEBBC8wLTArBggrBgEFBQcwAYYfaHR0cDovL2lwYS1jYS50ZXN0My5hbHQvY2Evb2NzcDAOBgNVHQ8BAf8EBAMCBPAwHQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsGAQUFBwMCMHQGA1UdHwRtMGswaaAxoC+GLWh0dHA6Ly9pcGEtY2EudGVzdDMuYWx0L2lwYS9jcmwvTWFzdGVyQ1JMLmJpbqI0pDIwMDEOMAwGA1UECgwFaXBhY2ExHjAcBgNVBAMMFUNlcnRpZmljYXRlIEF1dGhvcml0eTAdBgNVHQ4EFgQU/vz0WK5daVHKe2KGpl6scCRkGXswFwYDVR0RBBAwDoEMZXNAdGVzdDMuYWx0MA0GCSqGSIb3DQEBCwUAA4IBgQA9tFqv/4F5AFJafw9rYYba1L5czU6Z3dwlSe65nGfbMKZXckkR3a7zta0UoR1FHJS16mq477ycS/RUKNt2BczPsT2B2lN3A32gII46TTsplK8pRPFnDTX5iCDBY3XIrgIFFtGCaNn9Cdj55aKHj9oVgary+V8mxehoPZF3Y0X9Y1EE7ji1fNsDrJneX/RYNUJZVKmkPeM2tTccthK5k+ftsykEMFKadIzA9QbDnw6YQ7RxHTIk5sUP004qJZFMVDzWiUhd1ruvoSUz/sgLNXfl1avokPIumojZuP5ZPy15Gm3Q2vXsEGm0qROHVBWUTVBhps5RgdvMF77nGppPTwo82MFQCinVS/oKFt8geQ1EMx8TTHLMxHDF5FiSg6QXl4fPyfI1wMWgssIkNBP6Y4nwygERJttW7cHs2cBufyjFmm1xfh2I6nmFJUIXyIZU+llKLIlmT2GIK+hzBXwb82zvv++lDsP6hmNX6DcF7AUGwxEab/R8zLRCBxGSVHnBsjg=*
  Subject: CN=es,O=TEST3.ALT
  Subject email address: es@test3.alt
  Issuer: CN=Certificate Authority,O=TEST3.ALT
  Not Before: Wed Mar 30 12:55:53 2022 UTC
  Not After: Sat Mar 30 12:55:53 2024 UTC
  *Serial number: 12*
  Serial number (hex): 0xC
----

выпускаем сертификат для пользователя *jc* (токен JaCarta-2 SE)
[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *ipa cert-request jc.csr --principal jc*
  Issuing CA: ipa
  *Certificate: MIIEkTCCAvmgAwIBAgIBETANBgkqhkiG9w0BAQsFADA0MRIwEAYDVQQKDAlURVNUMy5BTFQxHjAcBgNVBAMMFUNlcnRpZmljYXRlIEF1dGhvcml0eTAeFw0yMjA0MTMxNjE5MjBaFw0yNDA0MTMxNjE5MjBaMCExEjAQBgNVBAoMCVRFU1QzLkFMVDELMAkGA1UEAwwCamMwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCilMBH0MxHRtgRkDr17Vqtk3e028xHEhwzSflyYNo4L0hKqa3NYduzw9JdWQ6DqvMaypeCpVEfMy6mIMQQqGJd8sqxsBJZEh+Q6yuKZuZpLjg1fm7NNi74WJMjaSoh+C8n4U42LmGvMPrYQiX5f0K+mj5qi3zhAh1GbtIEoipZKPppp0v9NpJ5EPS1X2jSfWJVJR2WLG4HyZGfJVOmYBayLjmR6433AhQbT+8yPirenjkvs7+EH1rICnMxACRS4GFWpjkc+EZPV+s+4Xee2xhZwtw4i3imz4l/jJO2lfHnUXddLnpc4pWhvkuR4TY6IyCzam1lCCvWgBa6dKpHFDFdAgMBAAGjggE/MIIBOzAfBgNVHSMEGDAWgBTRbNlqXldCVUQNKGu66SHbUA7efTA7BggrBgEFBQcBAQQvMC0wKwYIKwYBBQUHMAGGH2h0dHA6Ly9pcGEtY2EudGVzdDMuYWx0L2NhL29jc3AwDgYDVR0PAQH/BAQDAgTwMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjB0BgNVHR8EbTBrMGmgMaAvhi1odHRwOi8vaXBhLWNhLnRlc3QzLmFsdC9pcGEvY3JsL01hc3RlckNSTC5iaW6iNKQyMDAxDjAMBgNVBAoMBWlwYWNhMR4wHAYDVQQDDBVDZXJ0aWZpY2F0ZSBBdXRob3JpdHkwHQYDVR0OBBYEFOKE4VGJ5KepoGfhDsC1eIMIK8M+MBcGA1UdEQQQMA6BDGpjQHRlc3QzLmFsdDANBgkqhkiG9w0BAQsFAAOCAYEAZ2BHv4jNC2A1mjQ+XQWGpgvcwOaKqgAqrgN8gWVFG1SEdQ0yUVpAzLJUWdofp4quvipkmia6bH/7paniEK6GqPEgljRw9HQ+rOHeXbPuxODDpsiT1ItWTk3l9biE8EOxewJM10jgNpkdOZ4IrWJ/LcSl97fMHfaxdZvJaNqGVP4AW0LrA3PWfD3S0PMOjvSJLhEO2TIJSdjfrkqEfQQntEvGZfNMTeaXT5JLNEwHcoYWNxHtF4SXtXUwugYLsn45CC7hyTrX7Cv3hE37Q1XeOTzCH8sVaYsneJX9uKsQ5O1zDvpVsHoSvUulKWeLIBuLRsOSECmut1vqi+Lixfi4eHg3ocghqdmS9pNdNRTFafoW4CK1PGD4cyXsBYJ40mVwj0GjXMGCmo0f3EF8f97tqlROreUH3y3W/bD1jiYM2pMEE/8wngA+LXW1dP/vdrTJ2OujqsLphiN74HKFoooME0CkXbAVMz3zw80AAcmEbypcGc+VUD9vHx78L8ZE6BB0*
  Subject: CN=jc,O=TEST3.ALT
  Subject email address: jc@test3.alt
  Issuer: CN=Certificate Authority,O=TEST3.ALT
  Not Before: Wed Apr 13 16:19:20 2022 UTC
  Not After: Sat Apr 13 16:19:20 2024 UTC
  *Serial number: 17*
  Serial number (hex): 0x11
----

Просмотрим профиль пользователя и убедимся что в нем есть сертификат (на примере *rt*):

[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *ipa user-show rt*
  User login: rt
  First name: Active
  Last name: Rutoken
  Home directory: /home/rt
  Login shell: /bin/bash
  Principal name: rt@TEST3.ALT
  Principal alias: rt@TEST3.ALT
  Email address: rt@test3.alt
  UID: 1450000001
  GID: 1450000001
  *Certificate: MIIEkTCCAvmgAwIBAgIBCzANBgkqhkiG9w0BAQsFADA0MRIwEAYDVQQKDAlURVNUMy5BTFQxHjAcBgNVBAMMFUNlcnRpZmljYXRlIEF1dGhvcml0eTAeFw0yMjAzMzAxMjQ4NTVaFw0yNDAzMzAxMjQ4NTVaMCExEjAQBgNVBAoMCVRFU1QzLkFMVDELMAkGA1UEAwwCcnQwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDixyi3OLL16b8dxldRWIPLWVDtWS5yBtyiPJw7akrO0Vuhz7+Ei280Pnubsjv/q1h2OKZ1YbHJhuQayLk+JPBTzn4AEoARHUfWU3XIZtSF1Fu/udTRi1ANIeoKyuSL2AQiz217dsU9Zfne15bWTudJCHQJ2CTLDtYV/mhapSwoxNsrBAKLGgv4xZXPI9AQ1aA/ZgP1FFedHzkzh89VDuMQlpHROXDS5jFDhsC9AMZcslettypr3/hcbQoJJmOZE28NtAKb/15EqIFkt+qalz4jsNBYsW7EZ9bJQV1rhotQLj8EdE1U3UwDwYFTDRaIDS4slL3le0/hk96xVO28lNeTAgMBAAGjggE/MIIBOzAfBgNVHSMEGDAWgBTRbNlqXldCVUQNKGu66SHbUA7efTA7BggrBgEFBQcBAQQvMC0wKwYIKwYBBQUHMAGGH2h0dHA6Ly9pcGEtY2EudGVzdDMuYWx0L2NhL29jc3AwDgYDVR0PAQH/BAQDAgTwMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjB0BgNVHR8EbTBrMGmgMaAvhi1odHRwOi8vaXBhLWNhLnRlc3QzLmFsdC9pcGEvY3JsL01hc3RlckNSTC5iaW6iNKQyMDAxDjAMBgNVBAoMBWlwYWNhMR4wHAYDVQQDDBVDZXJ0aWZpY2F0ZSBBdXRob3JpdHkwHQYDVR0OBBYEFCFX+7558EUtkCOET2oPWR17nTy3MBcGA1UdEQQQMA6BDHJ0QHRlc3QzLmFsdDANBgkqhkiG9w0BAQsFAAOCAYEAXSzbY7CrpoI1Tv6Ejmsvan545DU+2FXICE9vUFlP9601yUU4HNRQobPc8huSBkqZUkdAtERHBUZ/JrwY777+G/J8S1au6SiDK9LwuRwABTV7jJ3hhWB7qxTrWhu1ErdoCToN1kRsek5W/ske+LWM/Ubx9q2vdW/eUjK69GtwbLAWgWZFA1U7PfpDrhk1RPJ7RPPU+o0qToKhz/02JZRsZOZE1/KR5hpGcgOWeE0cG2aAIDxGu4wN2KlHqY4bcefIiLLnwXyZ1Z3jhwYa4A/0qlhqUN7wn3lve/+MctFzh7HA3ULt+egUz8q8Ub1BfN33i1nbdFtxbK6LllJaszxtILIMpu62XeZt33qMpm4ZvuiEJRTF3ewz+lhWYJwLoZLgxHLhtjbht2/Xebd4i2g31jsMusJ556Yq0chpFEw293q+FXjpbHJGiCtgUEsVU77ufKD7+gmqjMGZTkPyvlhZDaXZpKkZeAtXcH39yOs0w6haTBMSFA+HszrseRkSVV2u*
  Account disabled: False
  Password: False
  Member of groups: ipausers
  Kerberos keys available: False
----

=== Копируем сертификат клиента на токен

Прежде чем скопировать сертификаты на токен их сначала необходимо экспортировать из профиля пользователя. Чтобы экспортировать сертификаты, нужно знать серийный номер сертификата в базе. Серийный номер сертификата указывается при его выпуске. Также узнать его можно при помощи следующей команды:

[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *ipa cert-find --user=rt*
---------------------
1 certificate matched
---------------------
  Issuing CA: ipa
  Subject: CN=rt,O=TEST3.ALT
  Issuer: CN=Certificate Authority,O=TEST3.ALT
  Not Before: Wed Mar 30 15:48:55 2022 UTC
  Not After: Sat Mar 30 15:48:55 2024 UTC
  *Serial number: 11*
  Serial number (hex): 0xB
  Status: VALID
  Revoked: False
----------------------------
Number of entries returned 1
----------------------------

----

экпортируем сертификат пользователя *rt*

[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *ipa cert-show 11 --certificate-out=rt.pem*
  Issuing CA: ipa
  Certificate: MIIEkTCCAvmgAwIBAgIBCzANBgkqhkiG9w0BAQsFADA0MRIwEAYDVQQKDAlURVNUMy5BTFQxHjAcBgNVBAMMFUNlcnRpZmljYXRlIEF1dGhvcml0eTAeFw0yMjAzMzAxMjQ4NTVaFw0yNDAzMzAxMjQ4NTVaMCExEjAQBgNVBAoMCVRFU1QzLkFMVDELMAkGA1UEAwwCcnQwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDixyi3OLL16b8dxldRWIPLWVDtWS5yBtyiPJw7akrO0Vuhz7+Ei280Pnubsjv/q1h2OKZ1YbHJhuQayLk+JPBTzn4AEoARHUfWU3XIZtSF1Fu/udTRi1ANIeoKyuSL2AQiz217dsU9Zfne15bWTudJCHQJ2CTLDtYV/mhapSwoxNsrBAKLGgv4xZXPI9AQ1aA/ZgP1FFedHzkzh89VDuMQlpHROXDS5jFDhsC9AMZcslettypr3/hcbQoJJmOZE28NtAKb/15EqIFkt+qalz4jsNBYsW7EZ9bJQV1rhotQLj8EdE1U3UwDwYFTDRaIDS4slL3le0/hk96xVO28lNeTAgMBAAGjggE/MIIBOzAfBgNVHSMEGDAWgBTRbNlqXldCVUQNKGu66SHbUA7efTA7BggrBgEFBQcBAQQvMC0wKwYIKwYBBQUHMAGGH2h0dHA6Ly9pcGEtY2EudGVzdDMuYWx0L2NhL29jc3AwDgYDVR0PAQH/BAQDAgTwMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjB0BgNVHR8EbTBrMGmgMaAvhi1odHRwOi8vaXBhLWNhLnRlc3QzLmFsdC9pcGEvY3JsL01hc3RlckNSTC5iaW6iNKQyMDAxDjAMBgNVBAoMBWlwYWNhMR4wHAYDVQQDDBVDZXJ0aWZpY2F0ZSBBdXRob3JpdHkwHQYDVR0OBBYEFCFX+7558EUtkCOET2oPWR17nTy3MBcGA1UdEQQQMA6BDHJ0QHRlc3QzLmFsdDANBgkqhkiG9w0BAQsFAAOCAYEAXSzbY7CrpoI1Tv6Ejmsvan545DU+2FXICE9vUFlP9601yUU4HNRQobPc8huSBkqZUkdAtERHBUZ/JrwY777+G/J8S1au6SiDK9LwuRwABTV7jJ3hhWB7qxTrWhu1ErdoCToN1kRsek5W/ske+LWM/Ubx9q2vdW/eUjK69GtwbLAWgWZFA1U7PfpDrhk1RPJ7RPPU+o0qToKhz/02JZRsZOZE1/KR5hpGcgOWeE0cG2aAIDxGu4wN2KlHqY4bcefIiLLnwXyZ1Z3jhwYa4A/0qlhqUN7wn3lve/+MctFzh7HA3ULt+egUz8q8Ub1BfN33i1nbdFtxbK6LllJaszxtILIMpu62XeZt33qMpm4ZvuiEJRTF3ewz+lhWYJwLoZLgxHLhtjbht2/Xebd4i2g31jsMusJ556Yq0chpFEw293q+FXjpbHJGiCtgUEsVU77ufKD7+gmqjMGZTkPyvlhZDaXZpKkZeAtXcH39yOs0w6haTBMSFA+HszrseRkSVV2u
  Subject: CN=rt,O=TEST3.ALT
  Subject email address: rt@test3.alt
  Issuer: CN=Certificate Authority,O=TEST3.ALT
  Not Before: Wed Mar 30 12:48:55 2022 UTC
  Not After: Sat Mar 30 12:48:55 2024 UTC
  Serial number: 11
  Serial number (hex): 0xB
  Revoked: False
  Owner user: rt
----

экпортируем сертификат пользователя *es*

[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *ipa cert-show 12 --certificate-out=es.pem*
  Issuing CA: ipa
  Certificate: MIIEkDCCAvigAwIBAgIBDDANBgkqhkiG9w0BAQsFADA0MRIwEAYDVQQKDAlURVNUMy5BTFQxHjAcBgNVBAMMFUNlcnRpZmljYXRlIEF1dGhvcml0eTAeFw0yMjAzMzAxMjU1NTNaFw0yNDAzMzAxMjU1NTNaMCExEjAQBgNVBAoMCVRFU1QzLkFMVDELMAkGA1UEAwwCZXMwggEhMA0GCSqGSIb3DQEBAQUAA4IBDgAwggEJAoIBAHB7rEXrujSWW3OmUWqHXDxbFKNFU2j76pRQmK+5UbnnopoWfY6qGdb3EiYXnf9bBn1J06QU0FuDS8vZhNqYeb6Oc3zMKWMHtK+0EJXx/9BA+X7Yu8TsvKEAPKqHE8s44BsF/SYCyQ3Psoo550hDEnoy8b/gl2r8bs6YnFXns5sYDvL2O8frNtrN36jZIyqo7cE+OU+AXYyId+iXEnWEhUzoNeRAhoA6BV/gnnjsBdE7xkR2WoM6tlFROP5cXbL3rS/pwWR35uQlevgrrijnQS2a0ZJQ4pITm2wseefe0e0fyZwP+ot0xtENIRK2Ks08J70X21lDaIIQEPtdNzpYpo8CAwEAAaOCAT8wggE7MB8GA1UdIwQYMBaAFNFs2WpeV0JVRA0oa7rpIdtQDt59MDsGCCsGAQUFBwEBBC8wLTArBggrBgEFBQcwAYYfaHR0cDovL2lwYS1jYS50ZXN0My5hbHQvY2Evb2NzcDAOBgNVHQ8BAf8EBAMCBPAwHQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsGAQUFBwMCMHQGA1UdHwRtMGswaaAxoC+GLWh0dHA6Ly9pcGEtY2EudGVzdDMuYWx0L2lwYS9jcmwvTWFzdGVyQ1JMLmJpbqI0pDIwMDEOMAwGA1UECgwFaXBhY2ExHjAcBgNVBAMMFUNlcnRpZmljYXRlIEF1dGhvcml0eTAdBgNVHQ4EFgQU/vz0WK5daVHKe2KGpl6scCRkGXswFwYDVR0RBBAwDoEMZXNAdGVzdDMuYWx0MA0GCSqGSIb3DQEBCwUAA4IBgQA9tFqv/4F5AFJafw9rYYba1L5czU6Z3dwlSe65nGfbMKZXckkR3a7zta0UoR1FHJS16mq477ycS/RUKNt2BczPsT2B2lN3A32gII46TTsplK8pRPFnDTX5iCDBY3XIrgIFFtGCaNn9Cdj55aKHj9oVgary+V8mxehoPZF3Y0X9Y1EE7ji1fNsDrJneX/RYNUJZVKmkPeM2tTccthK5k+ftsykEMFKadIzA9QbDnw6YQ7RxHTIk5sUP004qJZFMVDzWiUhd1ruvoSUz/sgLNXfl1avokPIumojZuP5ZPy15Gm3Q2vXsEGm0qROHVBWUTVBhps5RgdvMF77nGppPTwo82MFQCinVS/oKFt8geQ1EMx8TTHLMxHDF5FiSg6QXl4fPyfI1wMWgssIkNBP6Y4nwygERJttW7cHs2cBufyjFmm1xfh2I6nmFJUIXyIZU+llKLIlmT2GIK+hzBXwb82zvv++lDsP6hmNX6DcF7AUGwxEab/R8zLRCBxGSVHnBsjg=
  Subject: CN=es,O=TEST3.ALT
  Subject email address: es@test3.alt
  Issuer: CN=Certificate Authority,O=TEST3.ALT
  Not Before: Wed Mar 30 12:55:53 2022 UTC
  Not After: Sat Mar 30 12:55:53 2024 UTC
  Serial number: 12
  Serial number (hex): 0xC
  Revoked: False
  Owner user: es
----

экпортируем сертификат пользователя *jc*

[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *ipa cert-show 17 --certificate-out=jc.pem*
  Issuing CA: ipa
  Certificate: MIIEkTCCAvmgAwIBAgIBETANBgkqhkiG9w0BAQsFADA0MRIwEAYDVQQKDAlURVNUMy5BTFQxHjAcBgNVBAMMFUNlcnRpZmljYXRlIEF1dGhvcml0eTAeFw0yMjA0MTMxNjE5MjBaFw0yNDA0MTMxNjE5MjBaMCExEjAQBgNVBAoMCVRFU1QzLkFMVDELMAkGA1UEAwwCamMwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCilMBH0MxHRtgRkDr17Vqtk3e028xHEhwzSflyYNo4L0hKqa3NYduzw9JdWQ6DqvMaypeCpVEfMy6mIMQQqGJd8sqxsBJZEh+Q6yuKZuZpLjg1fm7NNi74WJMjaSoh+C8n4U42LmGvMPrYQiX5f0K+mj5qi3zhAh1GbtIEoipZKPppp0v9NpJ5EPS1X2jSfWJVJR2WLG4HyZGfJVOmYBayLjmR6433AhQbT+8yPirenjkvs7+EH1rICnMxACRS4GFWpjkc+EZPV+s+4Xee2xhZwtw4i3imz4l/jJO2lfHnUXddLnpc4pWhvkuR4TY6IyCzam1lCCvWgBa6dKpHFDFdAgMBAAGjggE/MIIBOzAfBgNVHSMEGDAWgBTRbNlqXldCVUQNKGu66SHbUA7efTA7BggrBgEFBQcBAQQvMC0wKwYIKwYBBQUHMAGGH2h0dHA6Ly9pcGEtY2EudGVzdDMuYWx0L2NhL29jc3AwDgYDVR0PAQH/BAQDAgTwMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjB0BgNVHR8EbTBrMGmgMaAvhi1odHRwOi8vaXBhLWNhLnRlc3QzLmFsdC9pcGEvY3JsL01hc3RlckNSTC5iaW6iNKQyMDAxDjAMBgNVBAoMBWlwYWNhMR4wHAYDVQQDDBVDZXJ0aWZpY2F0ZSBBdXRob3JpdHkwHQYDVR0OBBYEFOKE4VGJ5KepoGfhDsC1eIMIK8M+MBcGA1UdEQQQMA6BDGpjQHRlc3QzLmFsdDANBgkqhkiG9w0BAQsFAAOCAYEAZ2BHv4jNC2A1mjQ+XQWGpgvcwOaKqgAqrgN8gWVFG1SEdQ0yUVpAzLJUWdofp4quvipkmia6bH/7paniEK6GqPEgljRw9HQ+rOHeXbPuxODDpsiT1ItWTk3l9biE8EOxewJM10jgNpkdOZ4IrWJ/LcSl97fMHfaxdZvJaNqGVP4AW0LrA3PWfD3S0PMOjvSJLhEO2TIJSdjfrkqEfQQntEvGZfNMTeaXT5JLNEwHcoYWNxHtF4SXtXUwugYLsn45CC7hyTrX7Cv3hE37Q1XeOTzCH8sVaYsneJX9uKsQ5O1zDvpVsHoSvUulKWeLIBuLRsOSECmut1vqi+Lixfi4eHg3ocghqdmS9pNdNRTFafoW4CK1PGD4cyXsBYJ40mVwj0GjXMGCmo0f3EF8f97tqlROreUH3y3W/bD1jiYM2pMEE/8wngA+LXW1dP/vdrTJ2OujqsLphiN74HKFoooME0CkXbAVMz3zw80AAcmEbypcGc+VUD9vHx78L8ZE6BB0
  Subject: CN=jc,O=TEST3.ALT
  Subject email address: jc@test3.alt
  Issuer: CN=Certificate Authority,O=TEST3.ALT
  Not Before: Wed Apr 13 16:19:20 2022 UTC
  Not After: Sat Apr 13 16:19:20 2024 UTC
  Serial number: 17
  Serial number (hex): 0x11
  Revoked: False
  Owner user: jc
----

Можно проверить сопоставление экспортированного сертификата с пользователем (на примере *jc*):

[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *ipa certmap-match jc.pem*
--------------
1 user matched
--------------
  Domain: TEST3.ALT
  User logins: jc
----------------------------
Number of entries returned 1
----------------------------
----

При записи сертификата на токен необходимо указывать идентификатор (id), с которым он будет храниться на токене. Этот идентификатор *должен* совпадать с идентификаторами закрытого и открытого ключей на токене для сохранения целостности цепочки.

Записываем сертификат пользователя *rt* на токен Рутокен ECP:

[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *pkcs11-tool --module /usr/lib64/p11-kit-proxy.so --login \
--pin 12345678 --write-object rt.pem --type cert --id 7001 --label rt_2fa_ipa*
Using slot 32 with a present token (0x30)
Created certificate:
Certificate Object; type = X.509 cert
  label:      rt_2fa_ipa
  subject:    DN: O=TEST3.ALT, CN=rt
  ID:         7001
----

Записываем сертификат пользователя *es* на токен ESMART Token:

[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *pkcs11-tool --module /usr/lib64/p11-kit-proxy.so --login \
--pin 12345678 --write-object es.pem --type cert --id 7002 --label es_2fa_ipa*
Using slot 0 with a present token (0x10)
Created certificate:
Certificate Object; type = X.509 cert
  label:      es_2fa_ipa
  subject:    DN: O=TEST3.ALT, CN=es
  ID:         7002
----

Записываем сертификат пользователя *jc* на токен JaCarta-2 SE:

[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *pkcs11-tool --module /usr/lib64/p11-kit-proxy.so --login \
--pin 11111111 --write-object jc.pem --type cert --id 7003 --label jc_2fa_ipa \
--token-label JC2SE-Laser*
Created certificate:
Certificate Object; type = X.509 cert
  label:      jc_2fa_ipa
  subject:    DN: O=TEST3.ALT, CN=jc
  ID:         7003
----

== Настраиваем PKINIT на клиенте

=== Настройка и проверка Kerberos

Укажем в конфигурационном файле Kerberos какие сертификаты использовать для аутентификации. Для этого установим правило, по которому Kerberos будет рассматривать сертификаты выданные только ЦС TEST3.ALT.
Добавляем правило `pkinit_cert_match = <ISSUER>.\*TEST3.ALT.*` в секцию `[libdefaults]` файла /etc/krb5.conf :

Итого получается следующий конфигурационный файл Kerberos:
[source,subs="verbatim,quotes"]
----
sp8-ws-211221 ~ # *cat /etc/krb5.conf | grep -viE '(\^#|^$)'*
includedir /etc/krb5.conf.d/
includedir /var/lib/sss/pubconf/krb5.include.d/
[libdefaults]
  default_realm = TEST3.ALT
  dns_lookup_realm = true
  dns_lookup_kdc = true
  rdns = false
  dns_canonicalize_hostname = false
  ticket_lifetime = 24h
  forwardable = true
  udp_preference_limit = 0
  default_ccache_name = KEYRING:persistent:%{uid}
        ##pkinit_cert_match = <ISSUER>.\*TEST3.ALT.*##
[realms]
  TEST3.ALT = {
    pkinit_anchors = FILE:/var/lib/ipa-client/pki/kdc-ca-bundle.pem
    pkinit_pool = FILE:/var/lib/ipa-client/pki/ca-bundle.pem
  }
[domain_realm]
  .test3.alt = TEST3.ALT
  test3.alt = TEST3.ALT
  sp8-ws-211221.test3.alt = TEST3.ALT
----

==== Рутокен ECP

Проверяем получение билета Kerberos для пользователя *rt*:
[source,subs="verbatim,quotes"]
----
user@sp8-ws-211221 ~ $ *kinit -V -X X509_user_identity='PKCS11:librtpkcs11ecp.so' rt*
Using existing cache: persistent:0:0
Using principal: rt@TEST3.ALT
PA Option X509_user_identity = PKCS11:librtpkcs11ecp.so
*r_token_ecp2                     PIN:*
Authenticated to Kerberos v5
sp8-ws-211221 ~ # *klist*
Ticket cache: KEYRING:persistent:0:0
Default principal: rt@TEST3.ALT

Valid starting       Expires              Service principal
04/05/2022 16:34:56  04/06/2022 16:34:48  krbtgt/TEST3.ALT@TEST3.ALT

----

`X509_user_identity='PKCS11:librtpkcs11ecp.so'` - указываем какую библиотеку pkcs11 использовать.

==== ESMART Token

Проверяем получение билета Kerberos для пользователя *es*:

[source,subs="verbatim,quotes"]
----
user@sp8-ws-211221 ~ $ *kinit -V -X X509_user_identity='PKCS11:libisbc_pkcs11_main.so' es*
Using new cache: persistent:0:krb_ccache_DNikg01
Using principal: es@TEST3.ALT
PA Option X509_user_identity = PKCS11:libisbc_pkcs11_main.so
*esmart_64                        PIN:*
Authenticated to Kerberos v5
user@sp8-ws-211221 ~ $ *klist*
Ticket cache: KEYRING:persistent:0:krb_ccache_DNikg01
Default principal: es@TEST3.ALT

Valid starting       Expires              Service principal
04/05/2022 17:04:02  04/06/2022 17:03:51  krbtgt/TEST3.ALT@TEST3.ALT

----

==== Jacarta-2 SE

В данном токене 3 слота. Для проверки работы Kerberos PKINIT нам необходимо указать правильный слот в добавлении к указанию используемой библиотеки.

Варианты указания месторасположения сертификата следующие (man krb5.conf): +
*PKCS11:[module_name=]modname[:slotid=slot-id][:token=token-label][:certid=cert-id][:certlabel=cert-label]*

Для указания слота подходят 2 варината: +

- *token-label* - метка токена
- *slot-id* - идентификатор слота. Указан в скобках после индекса слота при использовании утилиты pkcs11-tool - *"Slot 2 (#0x3ffff#): ..."*. В krb5.conf можно использовать, но указывать нужно переведя из шестнадцатиричного формата в десятеричный.

Проверяем получение билета Kerberos для пользователя *jc*:

[source,subs="verbatim,quotes"]
----
user@sp8-ws-211221 ~ $ *kinit -V -X X509_user_identity='PKCS11:libjcPKCS11-2.so:token=#JC2SE-Laser#' jc*
Using default cache: persistent:500:500
Using principal: jc@TEST3.ALT
PA Option X509_user_identity = PKCS11:libjcPKCS11-2.so:token=JC2SE-Laser
*JC2SE-Laser                      PIN:*
Authenticated to Kerberos v5
user@sp8-ws-211221 ~ $ *klist*
Ticket cache: KEYRING:persistent:500:500
Default principal: jc@TEST3.ALT

Valid starting       Expires              Service principal
04/14/2022 11:41:24  04/15/2022 11:41:05  krbtgt/TEST3.ALT@TEST3.ALT
----

WARNING: pve9 ~ # qm snapshot 195 snap007 --description "2fa_ipa; OK - kinit cert jacarta from cmd"

WARNING: pve9 ~ # qm snapshot 196 snap007 --description "2fa_ipa; OK - kinit cert jacarta from cmd"

==== Debug Kerberos

Если при проверке Kerberos возникают ошибки, то для более полной информации по процессу PKINIT добавьте опцию вывода отладочной информации в консоль (*KRB5_TRACE=/dev/stdout*). Команда получения билета Kerberos и вывод будут выглядеть следующим образом (для Рутокен ECP):

[source,subs="verbatim,quotes"]
----
user@sp8-ws-211221 ~ $ *KRB5_TRACE=/dev/stdout kinit \
-X X509_user_identity='PKCS11:librtpkcs11ecp.so' rt*
[5296] 1649240494.591302: Getting initial credentials for rt@TEST3.ALT
[5296] 1649240494.591304: Sending unauthenticated request
[5296] 1649240494.591305: Sending request (175 bytes) to TEST3.ALT
[5296] 1649240494.591306: Initiating TCP connection to stream 10.33.33.210:88
[5296] 1649240494.591307: Sending TCP request to stream 10.33.33.210:88
[5296] 1649240494.591308: Received answer (250 bytes) from stream 10.33.33.210:88
[5296] 1649240494.591309: Terminating TCP connection to stream 10.33.33.210:88
[5296] 1649240494.591310: Response was from master KDC
[5296] 1649240494.591311: Received error from KDC: -1765328359/Additional pre-authentication required
[5296] 1649240494.591314: Preauthenticating using KDC method data
[5296] 1649240494.591315: Processing preauth types: PA-PK-AS-REQ (16), PA-PK-AS-REP_OLD (15), PA-PK-AS-REQ_OLD (14), PA-FX-FAST (136), PA-PKINIT-KX (147), PA_AS_FRESHNESS (150), PA-FX-COOKIE (133)
[5296] 1649240494.591316: Received cookie: MIT
[5296] 1649240495.262891: Preauth module pkinit (147) (info) returned: 0/Success
[5296] 1649240495.262892: PKINIT client received freshness token from KDC
[5296] 1649240495.262893: Preauth module pkinit (150) (info) returned: 0/Success
*r_token_ecp2                     PIN:*
[5296] 1649240500.709145: PKINIT loading CA certs and CRLs from FILE
[5296] 1649240500.709146: PKINIT loading CA certs and CRLs from FILE
[5296] 1649240500.709147: PKINIT client computed kdc-req-body checksum 9/2B27DD006D278197B3597F00B87B5522EF90B292
[5296] 1649240500.709149: PKINIT client making DH request
[5296] 1649240502.839169: Preauth module pkinit (16) (real) returned: 0/Success
[5296] 1649240502.839170: Produced preauth for next request: PA-FX-COOKIE (133), PA-PK-AS-REQ (16)
[5296] 1649240502.839171: Sending request (2994 bytes) to TEST3.ALT
[5296] 1649240502.839172: Initiating TCP connection to stream 10.33.33.210:88
[5296] 1649240502.839173: Sending TCP request to stream 10.33.33.210:88
[5296] 1649240502.839174: Received answer (2868 bytes) from stream 10.33.33.210:88
[5296] 1649240502.839175: Terminating TCP connection to stream 10.33.33.210:88
[5296] 1649240502.839176: Response was from master KDC
[5296] 1649240502.839177: Processing preauth types: PA-PK-AS-REP (17)
[5296] 1649240502.839178: PKINIT client verified DH reply
[5296] 1649240502.839179: PKINIT client found id-pkinit-san in KDC cert: krbtgt/TEST3.ALT@TEST3.ALT
[5296] 1649240502.839180: PKINIT client matched KDC principal krbtgt/TEST3.ALT@TEST3.ALT against id-pkinit-san; no EKU check required
[5296] 1649240502.839181: PKINIT client used KDF 2B06010502030602 to compute reply key aes256-cts/9151
[5296] 1649240502.839182: Preauth module pkinit (17) (real) returned: 0/Success
[5296] 1649240502.839183: Produced preauth for next request: (empty)
[5296] 1649240502.839184: Salt derived from principal: TEST3.ALTrt
[5296] 1649240502.839185: AS key determined by preauth: aes256-cts/9151
[5296] 1649240502.839186: Decrypted AS reply; session key is: aes256-cts/72F1
[5296] 1649240502.839187: FAST negotiation: available
[5296] 1649240502.839188: Initializing KEYRING:persistent:0:0 with default princ rt@TEST3.ALT
[5296] 1649240502.839189: Storing rt@TEST3.ALT -> krbtgt/TEST3.ALT@TEST3.ALT in KEYRING:persistent:0:0
[5296] 1649240502.839190: Storing config in KEYRING:persistent:0:0 for krbtgt/TEST3.ALT@TEST3.ALT: fast_avail: yes
[5296] 1649240502.839191: Storing rt@TEST3.ALT -> krb5_ccache_conf_data/fast_avail/krbtgt\/TEST3.ALT\@TEST3.ALT@X-CACHECONF: in KEYRING:persistent:0:0
[5296] 1649240502.839192: Storing config in KEYRING:persistent:0:0 for krbtgt/TEST3.ALT@TEST3.ALT: pa_type: 16
[5296] 1649240502.839193: Storing rt@TEST3.ALT -> krb5_ccache_conf_data/pa_type/krbtgt\/TEST3.ALT\@TEST3.ALT@X-CACHECONF: in KEYRING:persistent:0:0
[5296] 1649240502.839194: Storing config in KEYRING:persistent:0:0 for krbtgt/TEST3.ALT@TEST3.ALT: pa_config_data: {"X509_user_identity":"PKCS11:module_name=librtpkcs11ecp.so"}
[5296] 1649240502.839195: Storing rt@TEST3.ALT -> krb5_ccache_conf_data/pa_config_data/krbtgt\/TEST3.ALT\@TEST3.ALT@X-CACHECONF: in KEYRING:persistent:0:0
----

=== Настройка SSSD

После ввода ПК клиента в домен FreeIPA за аутентификацию отвечает служба *SSSD*.
Утилита *p11_child*, входящая в состав пакета sssd, обеспечивает доступ к сертификату на токене.

Копируем сертификат ЦС на ПК доменного пользователя, в папку /etc/pki/tls/certs.
В этой директории служба SSSD будет искать сертификат ЦС.

[source,subs="verbatim,quotes"]
----
sp8-ws-211221 ~ # *ls -l /etc/pki/tls/certs/ca.pem*
-rw-r--r-- 1 root root 1627 Mar 30 19:23 /etc/pki/tls/certs/ca.pem
----

==== p11_child. Проверка работы SSSD c токенами

Проверим что sssd (p11_child) видит сертификат на токене Рутокен ECP:

[source,subs="verbatim,quotes"]
----
user@sp8-ws-211221 ~ $ */usr/libexec/sssd/p11_child --ca_db=/etc/pki/tls/certs/ca.pem --pre*
r_token_ecp2
/usr/lib64/pkcs11/librtpkcs11ecp.so
7001
rt_2fa_ipa
MIIEkTCCAvmgAwIBAgIBCzANBgkqhkiG9w0BAQsFADA0MRIwEAYDVQQKDAlURVNUMy5BTFQxHjAcBgNVBAMMFUNlcnRpZmljYXRlIEF1dGhvcml0eTAeFw0yMjAzMzAxMjQ4NTVaFw0yNDAzMzAxMjQ4NTVaMCExEjAQBgNVBAoMCVRFU1QzLkFMVDELMAkGA1UEAwwCcnQwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDixyi3OLL16b8dxldRWIPLWVDtWS5yBtyiPJw7akrO0Vuhz7+Ei280Pnubsjv/q1h2OKZ1YbHJhuQayLk+JPBTzn4AEoARHUfWU3XIZtSF1Fu/udTRi1ANIeoKyuSL2AQiz217dsU9Zfne15bWTudJCHQJ2CTLDtYV/mhapSwoxNsrBAKLGgv4xZXPI9AQ1aA/ZgP1FFedHzkzh89VDuMQlpHROXDS5jFDhsC9AMZcslettypr3/hcbQoJJmOZE28NtAKb/15EqIFkt+qalz4jsNBYsW7EZ9bJQV1rhotQLj8EdE1U3UwDwYFTDRaIDS4slL3le0/hk96xVO28lNeTAgMBAAGjggE/MIIBOzAfBgNVHSMEGDAWgBTRbNlqXldCVUQNKGu66SHbUA7efTA7BggrBgEFBQcBAQQvMC0wKwYIKwYBBQUHMAGGH2h0dHA6Ly9pcGEtY2EudGVzdDMuYWx0L2NhL29jc3AwDgYDVR0PAQH/BAQDAgTwMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjB0BgNVHR8EbTBrMGmgMaAvhi1odHRwOi8vaXBhLWNhLnRlc3QzLmFsdC9pcGEvY3JsL01hc3RlckNSTC5iaW6iNKQyMDAxDjAMBgNVBAoMBWlwYWNhMR4wHAYDVQQDDBVDZXJ0aWZpY2F0ZSBBdXRob3JpdHkwHQYDVR0OBBYEFCFX+7558EUtkCOET2oPWR17nTy3MBcGA1UdEQQQMA6BDHJ0QHRlc3QzLmFsdDANBgkqhkiG9w0BAQsFAAOCAYEAXSzbY7CrpoI1Tv6Ejmsvan545DU+2FXICE9vUFlP9601yUU4HNRQobPc8huSBkqZUkdAtERHBUZ/JrwY777+G/J8S1au6SiDK9LwuRwABTV7jJ3hhWB7qxTrWhu1ErdoCToN1kRsek5W/ske+LWM/Ubx9q2vdW/eUjK69GtwbLAWgWZFA1U7PfpDrhk1RPJ7RPPU+o0qToKhz/02JZRsZOZE1/KR5hpGcgOWeE0cG2aAIDxGu4wN2KlHqY4bcefIiLLnwXyZ1Z3jhwYa4A/0qlhqUN7wn3lve/+MctFzh7HA3ULt+egUz8q8Ub1BfN33i1nbdFtxbK6LllJaszxtILIMpu62XeZt33qMpm4ZvuiEJRTF3ewz+lhWYJwLoZLgxHLhtjbht2/Xebd4i2g31jsMusJ556Yq0chpFEw293q+FXjpbHJGiCtgUEsVU77ufKD7+gmqjMGZTkPyvlhZDaXZpKkZeAtXcH39yOs0w6haTBMSFA+HszrseRkSVV2u
----

Утилита p11_child определила:

- *r_token_ecp2* - метку (label) токена
- */usr/lib64/pkcs11/librtpkcs11ecp.so* - библиотеку, которая подходит для данного токена
- *7001* - идентификатор (id) сертификата
- *rt_2fa_ipa* - метку (label) сертификата на токене
- *MIIEkTC...kSVV2u* - собственно сам сертификат

Проверим что sssd (p11_child) видит сертификат на токене ESMART Token:

[source,subs="verbatim,quotes"]
----
user@sp8-ws-211221 ~ $ */usr/libexec/sssd/p11_child --ca_db=/etc/pki/tls/certs/ca.pem --pre*
esmart_64
/usr/lib64/pkcs11/libisbc_pkcs11_main.so
7002
es_2fa_ipa
MIIEkDCCAvigAwIBAgIBDDANBgkqhkiG9w0BAQsFADA0MRIwEAYDVQQKDAlURVNUMy5BTFQxHjAcBgNVBAMMFUNlcnRpZmljYXRlIEF1dGhvcml0eTAeFw0yMjAzMzAxMjU1NTNaFw0yNDAzMzAxMjU1NTNaMCExEjAQBgNVBAoMCVRFU1QzLkFMVDELMAkGA1UEAwwCZXMwggEhMA0GCSqGSIb3DQEBAQUAA4IBDgAwggEJAoIBAHB7rEXrujSWW3OmUWqHXDxbFKNFU2j76pRQmK+5UbnnopoWfY6qGdb3EiYXnf9bBn1J06QU0FuDS8vZhNqYeb6Oc3zMKWMHtK+0EJXx/9BA+X7Yu8TsvKEAPKqHE8s44BsF/SYCyQ3Psoo550hDEnoy8b/gl2r8bs6YnFXns5sYDvL2O8frNtrN36jZIyqo7cE+OU+AXYyId+iXEnWEhUzoNeRAhoA6BV/gnnjsBdE7xkR2WoM6tlFROP5cXbL3rS/pwWR35uQlevgrrijnQS2a0ZJQ4pITm2wseefe0e0fyZwP+ot0xtENIRK2Ks08J70X21lDaIIQEPtdNzpYpo8CAwEAAaOCAT8wggE7MB8GA1UdIwQYMBaAFNFs2WpeV0JVRA0oa7rpIdtQDt59MDsGCCsGAQUFBwEBBC8wLTArBggrBgEFBQcwAYYfaHR0cDovL2lwYS1jYS50ZXN0My5hbHQvY2Evb2NzcDAOBgNVHQ8BAf8EBAMCBPAwHQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsGAQUFBwMCMHQGA1UdHwRtMGswaaAxoC+GLWh0dHA6Ly9pcGEtY2EudGVzdDMuYWx0L2lwYS9jcmwvTWFzdGVyQ1JMLmJpbqI0pDIwMDEOMAwGA1UECgwFaXBhY2ExHjAcBgNVBAMMFUNlcnRpZmljYXRlIEF1dGhvcml0eTAdBgNVHQ4EFgQU/vz0WK5daVHKe2KGpl6scCRkGXswFwYDVR0RBBAwDoEMZXNAdGVzdDMuYWx0MA0GCSqGSIb3DQEBCwUAA4IBgQA9tFqv/4F5AFJafw9rYYba1L5czU6Z3dwlSe65nGfbMKZXckkR3a7zta0UoR1FHJS16mq477ycS/RUKNt2BczPsT2B2lN3A32gII46TTsplK8pRPFnDTX5iCDBY3XIrgIFFtGCaNn9Cdj55aKHj9oVgary+V8mxehoPZF3Y0X9Y1EE7ji1fNsDrJneX/RYNUJZVKmkPeM2tTccthK5k+ftsykEMFKadIzA9QbDnw6YQ7RxHTIk5sUP004qJZFMVDzWiUhd1ruvoSUz/sgLNXfl1avokPIumojZuP5ZPy15Gm3Q2vXsEGm0qROHVBWUTVBhps5RgdvMF77nGppPTwo82MFQCinVS/oKFt8geQ1EMx8TTHLMxHDF5FiSg6QXl4fPyfI1wMWgssIkNBP6Y4nwygERJttW7cHs2cBufyjFmm1xfh2I6nmFJUIXyIZU+llKLIlmT2GIK+hzBXwb82zvv++lDsP6hmNX6DcF7AUGwxEab/R8zLRCBxGSVHnBsjg=
----


Для проверки работы SSSD c токеном JaCarta-2 SE нам необходимо дополнительно указать слот. Сделать это можно при помощи схемы *pkcs11:<URI>*, которая поддерживается в SSSD. Вариантов схем *pkcs11:<URI>* много. С полным перечнем можно ознакомиться в RFC7512 (https://datatracker.ietf.org/doc/html/rfc7512#section-2.1). +
В данном случае мы будем использовать схему с указанием модели слота - *uri=pkcs11:model=JaCarta%20Laser*.

[source,subs="verbatim,quotes"]
----
user@sp8-ws-211221 ~ $ */usr/libexec/sssd/p11_child --ca_db=/etc/pki/tls/certs/ca.pem \
--pre --uri=pkcs11:model=JaCarta%20Laser*
JC2SE-Laser
/usr/lib64/pkcs11/libjcPKCS11-2.so
7003
jc_2fa_ipa
MIIEkTCCAvmgAwIBAgIBETANBgkqhkiG9w0BAQsFADA0MRIwEAYDVQQKDAlURVNUMy5BTFQxHjAcBgNVBAMMFUNlcnRpZmljYXRlIEF1dGhvcml0eTAeFw0yMjA0MTMxNjE5MjBaFw0yNDA0MTMxNjE5MjBaMCExEjAQBgNVBAoMCVRFU1QzLkFMVDELMAkGA1UEAwwCamMwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCilMBH0MxHRtgRkDr17Vqtk3e028xHEhwzSflyYNo4L0hKqa3NYduzw9JdWQ6DqvMaypeCpVEfMy6mIMQQqGJd8sqxsBJZEh+Q6yuKZuZpLjg1fm7NNi74WJMjaSoh+C8n4U42LmGvMPrYQiX5f0K+mj5qi3zhAh1GbtIEoipZKPppp0v9NpJ5EPS1X2jSfWJVJR2WLG4HyZGfJVOmYBayLjmR6433AhQbT+8yPirenjkvs7+EH1rICnMxACRS4GFWpjkc+EZPV+s+4Xee2xhZwtw4i3imz4l/jJO2lfHnUXddLnpc4pWhvkuR4TY6IyCzam1lCCvWgBa6dKpHFDFdAgMBAAGjggE/MIIBOzAfBgNVHSMEGDAWgBTRbNlqXldCVUQNKGu66SHbUA7efTA7BggrBgEFBQcBAQQvMC0wKwYIKwYBBQUHMAGGH2h0dHA6Ly9pcGEtY2EudGVzdDMuYWx0L2NhL29jc3AwDgYDVR0PAQH/BAQDAgTwMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjB0BgNVHR8EbTBrMGmgMaAvhi1odHRwOi8vaXBhLWNhLnRlc3QzLmFsdC9pcGEvY3JsL01hc3RlckNSTC5iaW6iNKQyMDAxDjAMBgNVBAoMBWlwYWNhMR4wHAYDVQQDDBVDZXJ0aWZpY2F0ZSBBdXRob3JpdHkwHQYDVR0OBBYEFOKE4VGJ5KepoGfhDsC1eIMIK8M+MBcGA1UdEQQQMA6BDGpjQHRlc3QzLmFsdDANBgkqhkiG9w0BAQsFAAOCAYEAZ2BHv4jNC2A1mjQ+XQWGpgvcwOaKqgAqrgN8gWVFG1SEdQ0yUVpAzLJUWdofp4quvipkmia6bH/7paniEK6GqPEgljRw9HQ+rOHeXbPuxODDpsiT1ItWTk3l9biE8EOxewJM10jgNpkdOZ4IrWJ/LcSl97fMHfaxdZvJaNqGVP4AW0LrA3PWfD3S0PMOjvSJLhEO2TIJSdjfrkqEfQQntEvGZfNMTeaXT5JLNEwHcoYWNxHtF4SXtXUwugYLsn45CC7hyTrX7Cv3hE37Q1XeOTzCH8sVaYsneJX9uKsQ5O1zDvpVsHoSvUulKWeLIBuLRsOSECmut1vqi+Lixfi4eHg3ocghqdmS9pNdNRTFafoW4CK1PGD4cyXsBYJ40mVwj0GjXMGCmo0f3EF8f97tqlROreUH3y3W/bD1jiYM2pMEE/8wngA+LXW1dP/vdrTJ2OujqsLphiN74HKFoooME0CkXbAVMz3zw80AAcmEbypcGc+VUD9vHx78L8ZE6BB0
----

==== sssd.conf. Настройка службы SSSD.

Теперь, когда проверена возможность работы службы SSSD с токенами, зададим в конфигурационном файле SSSD неообходимость использования аутентификации по токену. Для этого добавим секцию `[pam]` со следующим содержимым:

[source,subs="verbatim,quotes"]
----
[pam]
pam_cert_auth = True
pam_p11_allowed_services = +mate-screensaver, +lightdm
pam_cert_db_path = /etc/pki/tls/certs/ca.pem
----

- *pam_cert_auth* - определяем что следует проводит аутентификацию по сертификату
- *pam_p11_allowed_services* - определяем каким службам SSSD даст доступ к сертификату на токене
- *pam_cert_db_path* - указываем месторасположение сертификата ЦС

Так как аутентификация по токену занимает больше времени чем по паролю (поиск сертификата на токене, проверка сертификата по протоколу OCSP и т.п) необходимо увеличить таймауты для Kerberos и для p11_child. Добавим следующие параметры:

[source,subs="verbatim,quotes"]
----
[domain/test3.alt]
...
krb5_auth_timeout = 60
...
[pam]
...
p11_child_timeout = 60
----

В итоге конфигурационный файл SSSD примет следующий вид:

[source,subs="verbatim,quotes"]
----
sp8-ws-211221 ~ # *cat /etc/sssd/sssd.conf | grep -viE '(\^#|^$)'*
[domain/test3.alt]
id_provider = ipa
ipa_server = _srv_, ipa-sp8srv211221.test3.alt
ipa_domain = test3.alt
ipa_hostname = sp8-ws-211221.test3.alt
auth_provider = ipa
chpass_provider = ipa
access_provider = ipa
cache_credentials = True
ldap_tls_cacert = /etc/ipa/ca.crt
krb5_store_password_if_offline = True
*krb5_auth_timeout = 60*
[sssd]
config_file_version = 2
services = nss, pam, ssh, sudo
user = _sssd
domains = test3.alt
[nss]
[ssh]
[sudo]
*[pam]
pam_cert_auth = True
pam_p11_allowed_services = +mate-screensaver, +lightdm
pam_cert_db_path = /etc/pki/tls/certs/ca.pem
p11_child_timeout = 60*
----

После изменения конфигурации перезапустим службу, очистив при этом кеш SSSD:

[source,subs="verbatim,quotes"]
----
sp8-ws-211221 ~ # *systemctl stop sssd && rm -rf /var/lib/sss/db/** *\*
*&& systemctl start sssd*
----

== Проверяем 2ФА в текстовой консоли

При аутентификации по сертификату на токене, мы должны сначала получить приглашение ввести пин-код, до приглашения ввести пароль. И если пин-код правильный, то аутентификация должна пройти успешно, иначе - отказ. +
После успешной аутентификации мы должны получить действующий билет Kerberos.

=== Рутокен ECP

[source,subs="verbatim,quotes"]
----
sp8-ws-211221 login: *rt*
#PIN for r_token_ecp2:#
rt@sp8-ws-211221 ~ $ *klist*
Ticket cache: KEYRING:persistent:1450000001:krb_ccache_v41ZW1c
Default principal: rt@TEST3.ALT

Valid starting       Expires              Service principal
06.04.2022 11:47:38  07.04.2022 11:47:34  krbtgt/TEST3.ALT@TEST3.ALT
rt@sp8-ws-211221 ~ $ *id*
uid=1450000001(rt) gid=1450000001(rt) группы=1450000001(rt)
----

Проверяем отказ в аутентификации при вводе некорректного PIN-кода:

[source,subs="verbatim,quotes"]
----
sp8-ws-211221 login: *rt*
PIN for r_token_ecp2:	_неверный пин-код_
*Login incorrect*
----

=== ESMART Token

[source,subs="verbatim,quotes"]
----
sp8-ws-211221 login: *es*
#PIN for esmart_64:#
Last login: Fri Apr  1 13:32:07 MSK 2022 on ttyS0
es@sp8-ws-211221 ~ $ *klist*
Ticket cache: KEYRING:persistent:1450000004:krb_ccache_947lzAG
Default principal: es@TEST3.ALT

Valid starting       Expires              Service principal
06.04.2022 11:53:40  07.04.2022 11:53:36  krbtgt/TEST3.ALT@TEST3.ALT
es@sp8-ws-211221 ~ $ *id*
uid=1450000004(es) gid=1450000004(es) группы=1450000004(es)
----

Проверяем отказ в аутентификации при вводе некорректного PIN-кода:

[source,subs="verbatim,quotes"]
----
login: *es*
PIN for esmart_64:	_неверный пин-код_
*Login incorrect*
----

=== Jacarta-2 SE

Так как данный токен является многослотовым, то службе SSSD необходимо указать с каким слотом работать. Для этого добавим параметр *p11_uri=pkcs11:model=JaCarta%20Laser*, указывающий слот по его модели,  в секцию *[pam]*.

Конфигурационный файл SSSD для Jacarta-2 SE:

[source,subs="verbatim,quotes"]
----
sp8-ws-211221 ~ # *cat /etc/sssd/sssd.conf | grep -viE '(\^#|^$)'*
[domain/test3.alt]
id_provider = ipa
ipa_server = _srv_, ipa-sp8srv211221.test3.alt
ipa_domain = test3.alt
ipa_hostname = sp8-ws-211221.test3.alt
auth_provider = ipa
chpass_provider = ipa
access_provider = ipa
cache_credentials = True
ldap_tls_cacert = /etc/ipa/ca.crt
krb5_store_password_if_offline = True
*krb5_auth_timeout = 60*
[sssd]
config_file_version = 2
services = nss, pam, ssh, sudo
user = _sssd
domains = test3.alt
[nss]
[ssh]
[sudo]
*[pam]
pam_cert_auth = True
pam_p11_allowed_services = +mate-screensaver, +lightdm
pam_cert_db_path = /etc/pki/tls/certs/ca.pem
##p11_uri=pkcs11:model=JaCarta%20Laser##
p11_child_timeout = 60*
----

Проверяем аутентификацию в консоли:

[source,subs="verbatim,quotes"]
----
sp8-ws-211221 login: *jc*
#PIN for JC2SE-Laser:#
Last login: Thu Apr 14 12:57:06 MSK 2022 on ttyS0
jc@sp8-ws-211221 ~ $ *klist*
Ticket cache: KEYRING:persistent:1450000003:krb_ccache_52q9mhr
Default principal: jc@TEST3.ALT

Valid starting       Expires              Service principal
14.04.2022 12:58:07  15.04.2022 12:57:54  krbtgt/TEST3.ALT@TEST3.ALT
jc@sp8-ws-211221 ~ $ *id*
uid=1450000003(jc) gid=1450000003(jc) группы=1450000003(jc)
----

Проверяем отказ в аутентификации при вводе некорректного PIN-кода:

[source,subs="verbatim,quotes"]
----
sp8-ws-211221 login: *jc*
PIN for JC2SE-Laser:	_неверный пин-код_
*Login incorrect*
----

== Проверяем 2ФА в графической сессии LightDM

=== Рутокен ECP

image::rt_0.png[align="center",scaledwidth="100%"]
image::rt_1.png[align="center",scaledwidth="100%"]
image::rt_2.png[align="center",scaledwidth="100%"]

Проверяем разблокировку сеанса в графической сессии Mate по сертификату:

image::rt_3.png[align="center"]

=== ESMART Token

image::es_0.png[align="center",scaledwidth="100%"]
image::es_1.png[align="center",scaledwidth="100%"]
image::es_2.png[align="center",scaledwidth="100%"]

Проверяем разблокировку сеанса в графической сессии Mate по сертификату:

image::es_3.png[align="center",scaledwidth="100%"]

WARNING: pve9 ~ # qm snapshot 195 snap008 --description "2fa_ipa; OK - console and LightDM logon for rt and es"

WARNING: pve9 ~ # qm snapshot 196 snap008 --description "2fa_ipa; OK - console and LightDM logon for rt and es"

===	Jacarta-2 SE

image::jc_0.png[align="center",scaledwidth="100%"]
image::jc_1.png[align="center",scaledwidth="100%"]
image::jc_2.png[align="center",scaledwidth="100%"]

Проверяем разблокировку сеанса в графической сессии Mate по сертификату:

image::jc_3.png[align="center",scaledwidth="100%"]

== Проверка отзыва сертификата

Для проверки отказа в аутентификации при отзыве сертификата (пример для пользователя *rt*, Рутокен ECP) выполним на сервере FreeIPA следующее:

[source,subs="verbatim,quotes"]
----
user@ipa-sp8srv211221 ~ $ *kinit admin*
Password for admin@TEST3.ALT:
user@ipa-sp8srv211221 ~ $ *ipa cert-revoke*
Serial number: 11
  *Revoked: True*
----

При этом сам сертификат остается в LDAP. Проверка валидности сертификата осуществляется по протоколу OCSP.

Пробуем аутентифицироваться в консоли на ПК клиента:

[source,subs="verbatim,quotes"]
----
sp8-ws-211221 login: *rt*
Password:
----

Обратите внимание что ввод пин-кода не предлагается. И поскольку пароль для пользователя изначально не был установлен, то происходит отказ в аутентификациию.

При этом в логах /var/log/sssd/p11_child.log можно увидеть следующие строки, в которых видно что сертификат отозван и он игнорируется:

[source,subs="verbatim"]
----
   *  (2022-04-06 14:35:34): [p11_child[5553]] [read_certs] (0x4000): found cert[rt_2fa_ipa][/O=TEST3.ALT/CN=rt]
   *  (2022-04-06 14:35:34): [p11_child[5553]] [do_ocsp] (0x4000): Using OCSP URL [http://ipa-ca.test3.alt/ca/ocsp].
   *  (2022-04-06 14:35:35): [p11_child[5553]] [do_ocsp] (0x4000): Nonce in OCSP response is the same as the one used in the request.
   *  (2022-04-06 14:35:35): [p11_child[5553]] [do_ocsp] (0x0020): OCSP check failed with [1][revoked].
********************** BACKTRACE DUMP ENDS HERE *********************************

(2022-04-06 14:35:35): [p11_child[5553]] [do_ocsp] (0x0020): Certificate is revoked [-1][(UNKNOWN)].
(2022-04-06 14:35:35): [p11_child[5553]] [do_verification] (0x0040): do_ocsp failed.
********************** PREVIOUS MESSAGE WAS TRIGGERED BY THE FOLLOWING BACKTRACE:
   *  (2022-04-06 14:35:35): [p11_child[5553]] [do_ocsp] (0x0020): Certificate is revoked [-1][(UNKNOWN)].
   *  (2022-04-06 14:35:35): [p11_child[5553]] [do_verification] (0x0040): do_ocsp failed.
********************** BACKTRACE DUMP ENDS HERE *********************************

(2022-04-06 14:35:35): [p11_child[5553]] [read_certs] (0x0040): Certificate [rt_2fa_ipa][/O=TEST3.ALT/CN=rt] not valid, skipping.
----

== Отладка SSSD

Если аутентификация по токену не работает как ожидается, то для более полной информации по этому процессу добавьте опцию вывода отладочной информации в файлы логов SSSD. Логи SSSD находятся в директории `/var/log/sssd/*`. Добавление опции вывода отладочной информации необходимо добавить в те секции конфигурационного файла `sssd.conf`, которые необходимо исследовать. Выглядить это может примерно так:

[source,subs="verbatim,quotes"]
----
[domain/test3.alt]
*debug_level = 8*
...
[sssd]
*debug_level = 8*
...
[nss]
[ssh]
[sudo]
[pam]
*debug_level = 8*
...
----

*debug_level = 8* - уровень отладки при котором выводятся содержимое внутренних переменных функций SSSD.

Более подробно об уровнях отладки см. *man sssd.conf*.

WARNING: pve9 ~ # qm snapshot 195 snap015 --description "2fa_ipa; OK - console and LightDM logon for rt es jc softhsm2"

WARNING: pve9 ~ # qm snapshot 196 snap015 --description "2fa_ipa; OK - console and LightDM logon for rt es jc softhsm2"

== Полезные ссылки

- https://web.mit.edu/kerberos/krb5-latest/doc/admin/pkinit.html

- https://github.com/OpenSC/libp11
- https://sssd.io/troubleshooting/basics.html
- https://floblanc.wordpress.com/2017/06/02/freeipa-troubleshooting-smartcard-authentication/
- https://datatracker.ietf.org/doc/html/rfc7512#section-2.1
- https://www.mankier.com/5/sss-certmap
- https://sssd.io/troubleshooting/basics.html
- https://www.freeipa.org/page/Troubleshooting/Kerberos
- https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/linux_domain_identity_authentication_and_policy_guide/trouble-authentication
